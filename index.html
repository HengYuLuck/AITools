<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®å®æ™ºèƒ½èµ·åç¥å™¨ - AIç§‘å­¦èµ·å¥½å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 414px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .stats {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .form-section {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #D32F2F;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }
        
        .gender-group {
            display: flex;
            gap: 12px;
        }
        
        .gender-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .gender-option.active {
            border-color: #D32F2F;
            background: #D32F2F;
            color: white;
        }
        
        .datetime-group {
            display: flex;
            gap: 12px;
        }
        
        .datetime-input {
            flex: 1;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-section {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D32F2F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            width: 200px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #D32F2F, #FF6B6B);
            border-radius: 3px;
            animation: progress 3s ease-in-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .result-section {
            padding: 20px;
        }
        
        .bazi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .bazi-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .bazi-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .wuxing-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .wuxing-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .wuxing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .wuxing-name {
            font-weight: 600;
        }
        
        .wuxing-stars {
            color: #FFD700;
        }
        
        .name-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .name-card.best {
            border-color: #D32F2F;
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        }
        
        .name-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .name-text {
            font-size: 24px;
            font-weight: bold;
            color: #D32F2F;
        }
        
        .name-score {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
        }
        
        .name-stars {
            color: #FFD700;
            font-size: 18px;
            margin: 5px 0;
        }
        
        .name-meaning {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .name-wuxing {
            font-size: 13px;
            color: #888;
        }
        
        .share-section {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .share-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .retry-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            color: #D32F2F;
            border: 2px solid #D32F2F;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–é¡µè¡¨å• -->
        <div id="formSection" class="form-page">
            <div class="header">
                <div class="header-content">
                    <h1 class="title">ğŸ® å®å®æ™ºèƒ½èµ·åç¥å™¨ ğŸ®</h1>
                    <p class="subtitle">ä¼ æ‰¿åƒå¹´å‘½ç†æ™ºæ…§ï¼ŒAIç§‘å­¦èµ·å¥½å</p>
                    <p class="stats">ğŸ’« å·²ä¸º 100ä¸‡+ å®å®èµ·åæˆåŠŸ</p>
                </div>
            </div>
            
            <div class="form-section">
                <form id="namingForm">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¶ å®å®å§“æ°</label>
                        <input type="text" class="form-input" id="surname" placeholder="è¯·è¾“å…¥å§“æ°ï¼Œå¦‚ï¼šå¼ " maxlength="2" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¦ğŸ‘§ å®å®æ€§åˆ«</label>
                        <div class="gender-group">
                            <div class="gender-option" data-gender="male">ğŸ‘¦ ç”·å®</div>
                            <div class="gender-option" data-gender="female">ğŸ‘§ å¥³å®</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“… å‡ºç”Ÿæ—¥æœŸ</label>
                        <div class="datetime-group">
                            <input type="date" class="form-input datetime-input" id="birthDate" required>
                            <input type="time" class="form-input datetime-input" id="birthTime" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">ğŸ¯ ç«‹å³å…è´¹èµ·å</button>
                </form>
            </div>
        </div>
        
        <!-- åˆ†æé¡µé¢ -->
        <div id="loadingSection" class="loading-section hidden">
            <div class="loading-icon"></div>
            <div class="loading-text" id="loadingText">ğŸ”® æ­£åœ¨ä¸ºæ‚¨çš„å®å®åˆ†æ...</div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
        
        <!-- ç»“æœé¡µé¢ -->
        <div id="resultSection" class="result-section hidden">
            <div class="bazi-card">
                <div class="bazi-title">ğŸ“… å®å®å‘½ç†ä¿¡æ¯</div>
                <div class="bazi-info" id="baziInfo">
                    <!-- å…«å­—ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="wuxing-card">
                <div class="wuxing-title">ğŸ”¥ äº”è¡Œåˆ†æ</div>
                <div id="wuxingAnalysis">
                    <!-- äº”è¡Œåˆ†æå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div id="nameResults">
                <!-- æ¨èåå­—å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="share-section">
                <button class="share-btn" onclick="shareResult()">ğŸ“¤ åˆ†äº«åˆ°æœ‹å‹åœˆ</button>
                <button class="retry-btn" onclick="resetForm()">ğŸ”„ å†èµ·ä¸€ä¸ªåå­—</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å­—åº“æ•°æ® -->
    <script src="nameDatabase.js"></script>
    <script src="expandDatabase.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let selectedGender = '';
        let currentResult = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿é¡µé¢çŠ¶æ€æ­£ç¡® - åªæ˜¾ç¤ºè¡¨å•é¡µé¢
            showSection('formSection');
            
            initForm();
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
        });
        
        // åˆå§‹åŒ–è¡¨å•
        function initForm() {
            // æ€§åˆ«é€‰æ‹©
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    selectedGender = this.dataset.gender;
                });
            });
            
            // è¡¨å•æäº¤
            document.getElementById('namingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    startNaming();
                }
            });
        }
        
        // è¡¨å•éªŒè¯
        function validateForm() {
            const surname = document.getElementById('surname').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            
            if (!surname) {
                alert('è¯·è¾“å…¥å®å®å§“æ°');
                return false;
            }
            
            if (!selectedGender) {
                alert('è¯·é€‰æ‹©å®å®æ€§åˆ«');
                return false;
            }
            
            if (!birthDate || !birthTime) {
                alert('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´');
                return false;
            }
            
            return true;
        }
        
        // å¼€å§‹èµ·ååˆ†æ
        function startNaming() {
            console.log('å¼€å§‹èµ·ååˆ†æ...');
            try {
                showSection('loadingSection');
                
                const loadingTexts = [
                    'ğŸ”® æ­£åœ¨è®¡ç®—ç”Ÿè¾°å…«å­—...',
                    'ğŸŒŸ åˆ†æäº”è¡Œç¼ºå¤±ä¸­...',
                    'ğŸ’« åŒ¹é…æœ€ä½³ç”¨å­—ä¸­...',
                    'ğŸŠ ç”Ÿæˆä¸“å±å¥½åä¸­...'
                ];
                
                let index = 0;
                const interval = setInterval(() => {
                    try {
                        if (index < loadingTexts.length) {
                            const loadingTextElement = document.getElementById('loadingText');
                            if (loadingTextElement) {
                                loadingTextElement.textContent = loadingTexts[index];
                            }
                            index++;
                        } else {
                            clearInterval(interval);
                            setTimeout(() => {
                                generateResult();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Loading interval error:', error);
                        clearInterval(interval);
                    }
                }, 800);
            } catch (error) {
                console.error('startNaming error:', error);
                alert('èµ·åè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ç”Ÿæˆèµ·åç»“æœ
        function generateResult() {
            console.log('ç”Ÿæˆèµ·åç»“æœ...');
            try {
                const surname = document.getElementById('surname').value.trim();
                const birthDate = document.getElementById('birthDate').value;
                const birthTime = document.getElementById('birthTime').value;
                const gender = selectedGender;
                
                console.log('è¡¨å•æ•°æ®:', { surname, birthDate, birthTime, gender });
                
                // æ¨¡æ‹Ÿè®¡ç®—å…«å­—
                const bazi = calculateBazi(birthDate, birthTime);
                
                // æ¨¡æ‹Ÿäº”è¡Œåˆ†æ
                const wuxing = analyzeWuxing(bazi);
                
                // æ¨¡æ‹Ÿç”Ÿæˆåå­—
                const names = generateNames(surname, gender, wuxing);
                
                currentResult = {
                    surname,
                    gender,
                    birthDate,
                    birthTime,
                    bazi,
                    wuxing,
                    names
                };
                
                console.log('ç”Ÿæˆçš„ç»“æœ:', currentResult);
                displayResult();
            } catch (error) {
                console.error('generateResult error:', error);
                alert('ç”Ÿæˆç»“æœæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è®¡ç®—å…«å­—ï¼ˆçœŸå®ç®—æ³•ï¼‰
        function calculateBazi(date, time) {
            const heavenly = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const earthly = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            
            const birthDate = new Date(date + 'T' + time);
            const year = birthDate.getFullYear();
            const month = birthDate.getMonth() + 1;
            const day = birthDate.getDate();
            const hour = birthDate.getHours();
            
            // å¹´æŸ±è®¡ç®—ï¼ˆä»¥ç«‹æ˜¥ä¸ºç•Œï¼‰
            let lunarYear = year;
            const springStart = getSpringDate(year);
            if (birthDate < springStart) {
                lunarYear = year - 1;
            }
            
            const yearSky = heavenly[(lunarYear - 4) % 10];
            const yearEarth = earthly[(lunarYear - 4) % 12];
            
            // æœˆæŸ±è®¡ç®—ï¼ˆä»¥èŠ‚æ°”ä¸ºç•Œï¼‰
            const monthIndex = getSolarMonth(birthDate);
            const monthSkyIndex = ((lunarYear - 4) % 10) * 2 + monthIndex;
            const monthSky = heavenly[monthSkyIndex % 10];
            const monthEarth = earthly[(monthIndex + 2) % 12];
            
            // æ—¥æŸ±è®¡ç®—ï¼ˆå„’ç•¥æ—¥ç®—æ³•ï¼‰
            const julianDay = getJulianDay(year, month, day);
            const daySkyIndex = (julianDay - 11) % 10;
            const dayEarthIndex = (julianDay - 11) % 12;
            const daySky = heavenly[daySkyIndex];
            const dayEarth = earthly[dayEarthIndex];
            
            // æ—¶æŸ±è®¡ç®—
            const hourIndex = Math.floor((hour + 1) / 2) % 12;
            const hourSkyIndex = (daySkyIndex * 2 + hourIndex) % 10;
            const hourSky = heavenly[hourSkyIndex];
            const hourEarth = earthly[hourIndex];
            
            return {
                year: yearSky + yearEarth,
                month: monthSky + monthEarth,
                day: daySky + dayEarth,
                hour: hourSky + hourEarth,
                elements: {
                    year: getElementFromStem(yearSky),
                    month: getElementFromStem(monthSky),
                    day: getElementFromStem(daySky),
                    hour: getElementFromStem(hourSky)
                }
            };
        }
        
        // è·å–ç«‹æ˜¥æ—¥æœŸ
        function getSpringDate(year) {
            // ç®€åŒ–è®¡ç®—ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´ç²¾ç¡®çš„èŠ‚æ°”è®¡ç®—
            return new Date(year, 1, 4); // å¤§çº¦2æœˆ4æ—¥
        }
        
        // è·å–èŠ‚æ°”æœˆä»½
        function getSolarMonth(date) {
            const month = date.getMonth();
            const day = date.getDate();
            
            // ç®€åŒ–çš„èŠ‚æ°”è®¡ç®—
            const solarMonths = [11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            let solarMonth = solarMonths[month];
            
            // æ ¹æ®å…·ä½“æ—¥æœŸè°ƒæ•´ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            if ((month === 0 && day < 6) || (month === 11 && day >= 6)) {
                solarMonth = month === 0 ? 11 : 0;
            }
            
            return solarMonth;
        }
        
        // å„’ç•¥æ—¥è®¡ç®—
        function getJulianDay(year, month, day) {
            if (month <= 2) {
                year -= 1;
                month += 12;
            }
            const a = Math.floor(year / 100);
            const b = 2 - a + Math.floor(a / 4);
            return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + b - 1524;
        }
        
        // ä»å¤©å¹²è·å–äº”è¡Œ
        function getElementFromStem(stem) {
            const stemElements = {
                'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
                'ä¸™': 'ç«', 'ä¸': 'ç«',
                'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
                'åºš': 'é‡‘', 'è¾›': 'é‡‘',
                'å£¬': 'æ°´', 'ç™¸': 'æ°´'
            };
            return stemElements[stem] || 'æœ¨';
        }
        
        // äº”è¡Œåˆ†æï¼ˆçœŸå®ç®—æ³•ï¼‰
        function analyzeWuxing(bazi) {
            // ç»Ÿè®¡å…«å­—ä¸­çš„äº”è¡Œ
            const elements = { 'é‡‘': 0, 'æœ¨': 0, 'æ°´': 0, 'ç«': 0, 'åœŸ': 0 };
            
            // ä»å¤©å¹²åˆ†æ
            Object.values(bazi.elements).forEach(element => {
                elements[element]++;
            });
            
            // ä»åœ°æ”¯åˆ†æï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            const branchElements = {
                'å­': 'æ°´', 'äº¥': 'æ°´',
                'å¯…': 'æœ¨', 'å¯': 'æœ¨',
                'å·³': 'ç«', 'åˆ': 'ç«',
                'ç”³': 'é‡‘', 'é…‰': 'é‡‘',
                'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ'
            };
            
            [bazi.year, bazi.month, bazi.day, bazi.hour].forEach(pillar => {
                const branch = pillar[1];
                const element = branchElements[branch];
                if (element) {
                    elements[element]++;
                }
            });
            
            // åˆ†æäº”è¡Œå¼ºå¼±
            const total = Object.values(elements).reduce((sum, count) => sum + count, 0);
            const lacking = [];
            const weak = [];
            const strong = [];
            
            Object.entries(elements).forEach(([element, count]) => {
                const percentage = count / total;
                if (count === 0) {
                    lacking.push(element);
                } else if (percentage < 0.15) {
                    weak.push(element);
                } else if (percentage > 0.3) {
                    strong.push(element);
                }
            });
            
            // ç”Ÿæˆå»ºè®®
            let suggestion = '';
            if (lacking.length > 0) {
                const needElement = lacking[0];
                suggestion = `äº”è¡Œç¼º${lacking.join('ã€')}ï¼Œå»ºè®®é€‰ç”¨${needElement}å­—æ—çš„å­—ï¼Œå¦‚ï¼š${getElementSamples(needElement)}`;
            } else if (weak.length > 0) {
                const needElement = weak[0];
                suggestion = `äº”è¡Œ${weak.join('ã€')}åå¼±ï¼Œå»ºè®®åŠ å¼º${needElement}å­—æ—çš„å­—ï¼Œå¦‚ï¼š${getElementSamples(needElement)}`;
            } else {
                suggestion = 'äº”è¡Œç›¸å¯¹å¹³è¡¡ï¼Œå¯æ ¹æ®éŸ³éŸµç¾æ„Ÿé€‰æ‹©ç”¨å­—';
            }
            
            return { 
                elements, 
                lacking, 
                weak,
                strong,
                suggestion,
                needElement: lacking.length > 0 ? lacking[0] : (weak.length > 0 ? weak[0] : null)
            };
        }
        
        // è·å–äº”è¡Œç”¨å­—ç¤ºä¾‹
        function getElementSamples(element) {
            const samples = {
                'é‡‘': 'é‘«ã€é’°ã€é“­ã€é”ã€é’¢',
                'æœ¨': 'æ—ã€æ£®ã€æ¥ ã€æŸã€æ¡‚', 
                'æ°´': 'æµ·ã€æ±Ÿã€æ¶›ã€æ¶¦ã€æ³½',
                'ç«': 'ç‚ã€ç…œã€çƒ¨ã€ç¿ã€æ™–',
                'åœŸ': 'å¤ã€åœ³ã€åŸã€åŸ¹ã€å ƒ'
            };
            return samples[element] || '';
        }
        
        // ç”Ÿæˆåå­—ï¼ˆå¢å¼ºç®—æ³•ï¼‰
        function generateNames(surname, gender, wuxing) {
            // è·å–å®Œæ•´çš„å­—åº“
            const nameDatabase = getNameDatabase();
            const targetElement = wuxing.needElement;
            
            // æ ¹æ®æ€§åˆ«å’Œäº”è¡Œéœ€æ±‚ç­›é€‰åˆé€‚çš„å­—
            let candidates = [];
            
            if (targetElement) {
                // ä¼˜å…ˆé€‰æ‹©è¡¥äº”è¡Œçš„å­—
                candidates = nameDatabase.filter(char => 
                    char.element === targetElement && 
                    char.gender.includes(gender)
                );
            }
            
            // å¦‚æœå€™é€‰å­—ä¸å¤Ÿï¼ŒåŠ å…¥é€šç”¨å¥½å­—
            if (candidates.length < 10) {
                const generalChars = nameDatabase.filter(char => 
                    char.gender.includes(gender) || char.gender.includes('both')
                );
                candidates = [...candidates, ...generalChars];
            }
            
            // éšæœºæ‰“ä¹±å€™é€‰å­—é¡ºåº
            candidates = shuffleArray([...candidates]);
            
            // ç”Ÿæˆåå­—ç»„åˆ
            const nameList = [];
            const maxAttempts = Math.min(candidates.length * candidates.length, 200); // é™åˆ¶å°è¯•æ¬¡æ•°
            
            for (let attempt = 0; attempt < maxAttempts && nameList.length < 20; attempt++) {
                // éšæœºé€‰æ‹©ä¸¤ä¸ªä¸åŒçš„å­—
                const index1 = Math.floor(Math.random() * candidates.length);
                let index2 = Math.floor(Math.random() * candidates.length);
                
                // ç¡®ä¿ä¸æ˜¯åŒä¸€ä¸ªå­—
                if (index1 === index2) {
                    index2 = (index1 + 1) % candidates.length;
                }
                
                const char1 = candidates[index1];
                const char2 = candidates[index2];
                
                // é¿å…é‡å¤çš„å­—ç¬¦
                if (char1.char === char2.char) continue;
                
                const name = char1.char + char2.char;
                const fullName = surname + name;
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡è¿™ä¸ªåå­—
                if (nameList.some(existing => existing.name === name)) continue;
                
                // è®¡ç®—åå­—è¯„åˆ†
                const score = calculateNameScore(surname, name, wuxing);
                
                // ç”Ÿæˆå¯“æ„è§£é‡Š
                const meaning = `${char1.char}ï¼ˆ${char1.meaning}ï¼‰${char2.char}ï¼ˆ${char2.meaning}ï¼‰`;
                
                // åˆ†æäº”è¡Œæ­é…
                const nameWuxing = char1.element + char2.element;
                
                nameList.push({
                    name,
                    fullName,
                    meaning,
                    score,
                    wuxing: nameWuxing,
                    isTop: false,
                    strokes: char1.strokes + char2.strokes,
                    phonetics: analyzePhonetics(fullName)
                });
            }
            
            // æŒ‰è¯„åˆ†æ’åº
            nameList.sort((a, b) => b.score - a.score);
            
            // æ ‡è®°æœ€ä½³åå­—
            nameList.forEach((name, index) => {
                name.isTop = index === 0;
            });
            
            return nameList.slice(0, 5);
        }
        
        // æ•°ç»„éšæœºæ‰“ä¹±å‡½æ•°
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // è·å–å­—åº“æ•°æ®
        function getNameDatabase() {
            // ä½¿ç”¨å¤–éƒ¨å­—åº“æ–‡ä»¶ä¸­çš„æ•°æ®
            return typeof NAME_DATABASE !== 'undefined' ? NAME_DATABASE : [];
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult() {
            console.log('å¼€å§‹æ˜¾ç¤ºç»“æœ...');
            try {
                // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
                const baziInfo = document.getElementById('baziInfo');
            baziInfo.innerHTML = `
                <div>å‡ºç”Ÿæ—¥æœŸï¼š${currentResult.birthDate}</div>
                <div>å‡ºç”Ÿæ—¶é—´ï¼š${currentResult.birthTime}</div>
                <div>å¹´æŸ±ï¼š${currentResult.bazi.year}</div>
                <div>æœˆæŸ±ï¼š${currentResult.bazi.month}</div>
                <div>æ—¥æŸ±ï¼š${currentResult.bazi.day}</div>
                <div>æ—¶æŸ±ï¼š${currentResult.bazi.hour}</div>
            `;
            
            // æ˜¾ç¤ºäº”è¡Œåˆ†æ
            const wuxingAnalysis = document.getElementById('wuxingAnalysis');
            let wuxingHtml = '';
            Object.entries(currentResult.wuxing.elements).forEach(([element, count]) => {
                const stars = 'â˜…'.repeat(count) + 'â˜†'.repeat(4 - count);
                wuxingHtml += `
                    <div class="wuxing-item">
                        <span class="wuxing-name">${element}ï¼š</span>
                        <span class="wuxing-stars">${stars}</span>
                    </div>
                `;
            });
            wuxingHtml += `<p style="margin-top: 15px; color: #666; font-size: 14px;">${currentResult.wuxing.suggestion}</p>`;
            wuxingAnalysis.innerHTML = wuxingHtml;
            
            // æ˜¾ç¤ºæ¨èåå­—
            const nameResults = document.getElementById('nameResults');
            let namesHtml = '';
            currentResult.names.forEach((name, index) => {
                const stars = 'â­'.repeat(Math.floor(name.score / 20));
                const complementInfo = currentResult.wuxing.needElement ? `ï¼Œè¡¥${currentResult.wuxing.needElement}å¼ºè¿` : '';
                
                namesHtml += `
                    <div class="name-card ${name.isTop ? 'best' : ''}">
                        <div class="name-header">
                            <div class="name-text">ã€${name.fullName}ã€‘</div>
                            <div class="name-score">${name.score}åˆ†</div>
                        </div>
                        <div class="name-stars">${stars}</div>
                        <div class="name-meaning">ğŸ“– ${name.meaning}</div>
                        <div class="name-wuxing">ğŸ”¥ äº”è¡Œï¼š${name.wuxing}${complementInfo}</div>
                        <div class="name-wuxing">âœï¸ ç¬”ç”»ï¼š${name.strokes}ç”»</div>
                        <div class="name-wuxing">ğŸµ éŸ³éŸµï¼š${name.phonetics.analysis}</div>
                    </div>
                `;
            });
            nameResults.innerHTML = namesHtml;
            
            showSection('resultSection');
            console.log('ç»“æœæ˜¾ç¤ºå®Œæˆ');
            } catch (error) {
                console.error('displayResult error:', error);
                alert('æ˜¾ç¤ºç»“æœæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åˆ‡æ¢æ˜¾ç¤ºçš„é¡µé¢
        function showSection(sectionId) {
            console.log('åˆ‡æ¢åˆ°é¡µé¢:', sectionId);
            try {
                const sections = ['formSection', 'loadingSection', 'resultSection'];
                
                // éšè—æ‰€æœ‰é¡µé¢
                sections.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        element.style.opacity = '0';
                    }
                });
                
                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.style.display = 'block';
                    targetSection.style.visibility = 'visible';
                    targetSection.style.opacity = '1';
                    targetSection.style.position = 'relative';
                    targetSection.style.left = 'auto';
                    console.log('æˆåŠŸæ˜¾ç¤ºé¡µé¢:', sectionId);
                } else {
                    console.error('æ‰¾ä¸åˆ°ç›®æ ‡é¡µé¢:', sectionId);
                }
            } catch (error) {
                console.error('showSection error:', error);
            }
        }
        
        // åˆ†äº«ç»“æœ
        function shareResult() {
            if (!currentResult) return;
            
            const shareText = `æˆ‘ç»™å®å®ç”¨AIèµ·äº†ä¸ªå¥½åå­—ï¼š${currentResult.names[0].fullName}ï¼Œç»¼åˆè¯„åˆ†${currentResult.names[0].score}åˆ†ï¼\n\nä¼ æ‰¿åƒå¹´å‘½ç†æ™ºæ…§ï¼ŒAIç§‘å­¦èµ·å¥½å\nğŸ‘¶ ä½ ä¹Ÿæƒ³ç»™å®å®èµ·ä¸ªå¥½åå­—å—ï¼Ÿ`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'å®å®æ™ºèƒ½èµ·åç¥å™¨',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    alert('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¿«å»æœ‹å‹åœˆåˆ†äº«å§ï¼');
                });
            }
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('namingForm').reset();
            document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
            selectedGender = '';
            currentResult = null;
            
            // é‡æ–°è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
            
            showSection('formSection');
        }
        
        // è®¡ç®—åå­—è¯„åˆ†
        function calculateNameScore(surname, name, wuxing) {
            let score = 0;
            
            // 1. äº”è¡ŒåŒ¹é…åº¦ (40åˆ†)
            if (wuxing.needElement) {
                const nameDatabase = getNameDatabase();
                const nameChars = name.split('');
                let matchCount = 0;
                
                nameChars.forEach(char => {
                    const charData = nameDatabase.find(c => c.char === char);
                    if (charData && charData.element === wuxing.needElement) {
                        matchCount++;
                    }
                });
                
                score += (matchCount / nameChars.length) * 40;
            } else {
                score += 35; // äº”è¡Œå¹³è¡¡æ—¶ç»™åŸºç¡€åˆ†
            }
            
            // 2. ç¬”ç”»æ•°ç† (25åˆ†)
            const strokeScore = calculateStrokeScore(surname, name);
            score += strokeScore;
            
            // 3. éŸ³éŸµç¾æ„Ÿ (20åˆ†)
            const phoneticScore = calculatePhoneticScore(surname + name);
            score += phoneticScore;
            
            // 4. å¯“æ„å‰ç¥¥ (15åˆ†)
            const meaningScore = calculateMeaningScore(name);
            score += meaningScore;
            
            return Math.round(score);
        }
        
        // è®¡ç®—ç¬”ç”»æ•°ç†è¯„åˆ†
        function calculateStrokeScore(surname, name) {
            const nameDatabase = getNameDatabase();
            const surnameStrokes = getCharStrokes(surname);
            
            let totalStrokes = surnameStrokes;
            name.split('').forEach(char => {
                const charData = nameDatabase.find(c => c.char === char);
                totalStrokes += charData ? charData.strokes : 10;
            });
            
            // æ ¹æ®æ€»ç¬”ç”»æ•°åˆ¤æ–­å‰å‡¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            const luckyNumbers = [1, 3, 5, 6, 7, 8, 11, 13, 15, 16, 17, 18, 21, 23, 24, 25, 29, 31, 32, 33, 35, 37, 39, 41, 45, 47, 48, 52, 57, 61, 63, 65, 67, 68, 81];
            
            if (luckyNumbers.includes(totalStrokes % 81)) {
                return 25;
            } else if (totalStrokes % 81 < 40) {
                return 15;
            } else {
                return 10;
            }
        }
        
        // è·å–å•å­—ç¬”ç”»æ•°
        function getCharStrokes(char) {
            const commonStrokes = {
                'ç‹': 4, 'æ': 7, 'å¼ ': 11, 'åˆ˜': 15, 'é™ˆ': 16, 'æ¨': 13, 'èµµ': 14, 'é»„': 12, 'å‘¨': 8, 'å´': 7,
                'å¾': 10, 'å­™': 6, 'èƒ¡': 9, 'æœ±': 6, 'é«˜': 10, 'æ—': 8, 'ä½•': 7, 'éƒ­': 15, 'é©¬': 10, 'ç½—': 19,
                'æ¢': 11, 'å®‹': 7, 'éƒ‘': 19, 'è°¢': 17, 'éŸ©': 17, 'å”': 10, 'å†¯': 12, 'äº': 3, 'è‘£': 15, 'è§': 18
            };
            return commonStrokes[char] || 8; // é»˜è®¤8ç”»
        }
        
        // è®¡ç®—éŸ³éŸµè¯„åˆ†
        function calculatePhoneticScore(fullName) {
            const tones = getTonesPattern(fullName);
            
            // æ£€æŸ¥å£°è°ƒæ­é…æ˜¯å¦å’Œè°
            if (tones.length >= 3) {
                // é¿å…ä¸‰ä¸ªå­—éƒ½æ˜¯åŒä¸€å£°è°ƒ
                if (tones[0] === tones[1] && tones[1] === tones[2]) {
                    return 10;
                }
                // å¹³ä»„ç›¸é—´æ¯”è¾ƒå¥½å¬
                if ((tones[0] !== tones[1]) && (tones[1] !== tones[2])) {
                    return 20;
                }
                return 15;
            }
            return 12;
        }
        
        // è·å–å­—çš„å£°è°ƒï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function getTonesPattern(name) {
            const toneMap = {
                // ä¸€å£°ï¼ˆé˜´å¹³ï¼‰
                'å¼ ': 1, 'ç‹': 2, 'æ': 3, 'åˆ˜': 2, 'é™ˆ': 2, 'æ¨': 2, 'å‘¨': 1, 'å´': 2,
                'é‘«': 1, 'é’°': 4, 'æ—': 2, 'æµ·': 3, 'ç‚': 2, 'å¤': 1,
                'è½©': 1, 'ç¿': 4, 'æ¶µ': 2, 'è¯—': 1, 'é›¨': 3, 'æ‚¦': 4
            };
            
            return name.split('').map(char => toneMap[char] || 2);
        }
        
        // è®¡ç®—å¯“æ„è¯„åˆ†
        function calculateMeaningScore(name) {
            const positiveChars = ['é‘«', 'é’°', 'æ—', 'æµ·', 'ç‚', 'å¤', 'è½©', 'ç¿', 'æ¶µ', 'è¯—', 'é›¨', 'æ‚¦', 'é›…', 'çª', 'ç‘¶', 'æ…§', 'å®‡', 'è¾°', 'æ™¨'];
            let score = 0;
            
            name.split('').forEach(char => {
                if (positiveChars.includes(char)) {
                    score += 7.5;
                } else {
                    score += 5;
                }
            });
            
            return Math.min(score, 15);
        }
        
        // éŸ³éŸµåˆ†æ
        function analyzePhonetics(fullName) {
            const tones = getTonesPattern(fullName);
            const toneNames = ['', 'å¹³å£°', 'ä¸Šå£°', 'å»å£°', 'å…¥å£°'];
            
            let pattern = tones.map(tone => toneNames[tone] || 'å¹³å£°').join('-');
            
            // åˆ¤æ–­éŸ³éŸµç‰¹ç‚¹
            let analysis = '';
            if (tones.every(tone => tone === tones[0])) {
                analysis = 'å£°è°ƒç»Ÿä¸€ï¼ŒéŸ³éŸµå¹³ç¨³';
            } else if (tones[0] !== tones[1] && tones[1] !== tones[2]) {
                analysis = 'å¹³ä»„ç›¸é—´ï¼Œæœ—æœ—ä¸Šå£';
            } else {
                analysis = 'éŸ³è°ƒå’Œè°ï¼Œæ‚¦è€³åŠ¨å¬';
            }
            
            return { pattern, analysis };
        }
    </script>
</body>
</html> 