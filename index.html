<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®å®æ™ºèƒ½èµ·åç¥å™¨ - AIç§‘å­¦èµ·å¥½å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 414px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .stats {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .form-section {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #D32F2F;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }
        
        .gender-group {
            display: flex;
            gap: 12px;
        }
        
        .gender-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .gender-option.active {
            border-color: #D32F2F;
            background: #D32F2F;
            color: white;
        }
        
        .datetime-group {
            display: flex;
            gap: 12px;
        }
        
        .datetime-input {
            flex: 1;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-section {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D32F2F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            width: 200px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #D32F2F, #FF6B6B);
            border-radius: 3px;
            animation: progress 3s ease-in-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .result-section {
            padding: 20px;
        }
        
        .bazi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .bazi-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .bazi-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .wuxing-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .wuxing-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .wuxing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .wuxing-name {
            font-weight: 600;
        }
        
        .wuxing-stars {
            color: #FFD700;
        }
        
        .name-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .name-card.best {
            border-color: #D32F2F;
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
            position: relative;
        }
        
        .name-card.best::before {
            content: 'â­ æœ€ä½³æ¨è';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #D32F2F;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .name-card.modern-combo {
            border-left: 4px solid #4ecdc4;
            background: linear-gradient(135deg, #f0ffff 0%, #ffffff 100%);
        }
        
        .name-badges {
            margin: 8px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .modern-badge {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .style-badge {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .name-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .name-text {
            font-size: 24px;
            font-weight: bold;
            color: #D32F2F;
        }
        
        .name-score {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
        }
        
        .name-pinyin {
            font-size: 13px;
            color: #666;
            margin: 5px 0;
            font-style: italic;
        }
        
        .name-stars {
            color: #FFD700;
            font-size: 18px;
            margin: 5px 0;
        }
        
        .name-meaning {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .name-wuxing {
            font-size: 13px;
            color: #888;
        }
        
        .share-section {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .share-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .retry-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            color: #D32F2F;
            border: 2px solid #D32F2F;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–é¡µè¡¨å• -->
        <div id="formSection" class="form-page">
            <div class="header">
                <div class="header-content">
                    <h1 class="title">ğŸ® å®å®æ™ºèƒ½èµ·åç¥å™¨ ğŸ®</h1>
                    <p class="subtitle">ä¼ æ‰¿åƒå¹´å‘½ç†æ™ºæ…§ï¼ŒAIç§‘å­¦èµ·å¥½å</p>
                    <p class="stats">ğŸ’« å·²ä¸º 100ä¸‡+ å®å®èµ·åæˆåŠŸ</p>
                </div>
            </div>
            
            <div class="form-section">
                <form id="namingForm">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¶ å®å®å§“æ°</label>
                        <input type="text" class="form-input" id="surname" placeholder="è¯·è¾“å…¥å§“æ°ï¼Œå¦‚ï¼šå¼ " maxlength="2" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¦ğŸ‘§ å®å®æ€§åˆ«</label>
                        <div class="gender-group">
                            <div class="gender-option" data-gender="male">ğŸ‘¦ ç”·å®</div>
                            <div class="gender-option" data-gender="female">ğŸ‘§ å¥³å®</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“… å‡ºç”Ÿæ—¥æœŸ</label>
                        <div class="datetime-group">
                            <input type="date" class="form-input datetime-input" id="birthDate" required>
                            <input type="time" class="form-input datetime-input" id="birthTime" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">ğŸ¯ ç«‹å³å…è´¹èµ·å</button>
                </form>
            </div>
        </div>
        
        <!-- åˆ†æé¡µé¢ -->
        <div id="loadingSection" class="loading-section hidden">
            <div class="loading-icon"></div>
            <div class="loading-text" id="loadingText">ğŸ”® æ­£åœ¨ä¸ºæ‚¨çš„å®å®åˆ†æ...</div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
        
        <!-- ç»“æœé¡µé¢ -->
        <div id="resultSection" class="result-section hidden">
            <div class="bazi-card">
                <div class="bazi-title">ğŸ“… å®å®å‘½ç†ä¿¡æ¯</div>
                <div class="bazi-info" id="baziInfo">
                    <!-- å…«å­—ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="wuxing-card">
                <div class="wuxing-title">ğŸ”¥ äº”è¡Œåˆ†æ</div>
                <div id="wuxingAnalysis">
                    <!-- äº”è¡Œåˆ†æå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div id="nameResults">
                <!-- æ¨èåå­—å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="share-section">
                <button class="share-btn" onclick="shareResult()">ğŸ“¤ åˆ†äº«åˆ°æœ‹å‹åœˆ</button>
                <button class="retry-btn" onclick="resetForm()">ğŸ”„ å†èµ·ä¸€ä¸ªåå­—</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å­—åº“æ•°æ® -->
    <script src="nameDatabase.js"></script>
    <script src="expandDatabase.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let selectedGender = '';
        let currentResult = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿é¡µé¢çŠ¶æ€æ­£ç¡® - åªæ˜¾ç¤ºè¡¨å•é¡µé¢
            showSection('formSection');
            
            initForm();
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
        });
        
        // åˆå§‹åŒ–è¡¨å•
        function initForm() {
            // æ€§åˆ«é€‰æ‹©
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    selectedGender = this.dataset.gender;
                });
            });
            
            // è¡¨å•æäº¤
            document.getElementById('namingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    startNaming();
                }
            });
        }
        
        // è¡¨å•éªŒè¯
        function validateForm() {
            const surname = document.getElementById('surname').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            
            if (!surname) {
                alert('è¯·è¾“å…¥å®å®å§“æ°');
                return false;
            }
            
            if (!selectedGender) {
                alert('è¯·é€‰æ‹©å®å®æ€§åˆ«');
                return false;
            }
            
            if (!birthDate || !birthTime) {
                alert('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´');
                return false;
            }
            
            return true;
        }
        
        // å¼€å§‹èµ·ååˆ†æ
        function startNaming() {
            console.log('å¼€å§‹èµ·ååˆ†æ...');
            try {
                showSection('loadingSection');
                
                const loadingTexts = [
                    'ğŸ”® æ­£åœ¨è®¡ç®—ç”Ÿè¾°å…«å­—...',
                    'ğŸŒŸ åˆ†æäº”è¡Œç¼ºå¤±ä¸­...',
                    'ğŸ’« åŒ¹é…æœ€ä½³ç”¨å­—ä¸­...',
                    'ğŸŠ ç”Ÿæˆä¸“å±å¥½åä¸­...'
                ];
                
                let index = 0;
                const interval = setInterval(() => {
                    try {
                        if (index < loadingTexts.length) {
                            const loadingTextElement = document.getElementById('loadingText');
                            if (loadingTextElement) {
                                loadingTextElement.textContent = loadingTexts[index];
                            }
                            index++;
                        } else {
                            clearInterval(interval);
                            setTimeout(() => {
                                generateResult();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Loading interval error:', error);
                        clearInterval(interval);
                    }
                }, 800);
            } catch (error) {
                console.error('startNaming error:', error);
                alert('èµ·åè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ç”Ÿæˆèµ·åç»“æœ
        function generateResult() {
            console.log('ç”Ÿæˆèµ·åç»“æœ...');
            try {
                const surname = document.getElementById('surname').value.trim();
                const birthDate = document.getElementById('birthDate').value;
                const birthTime = document.getElementById('birthTime').value;
                const gender = selectedGender;
                
                console.log('è¡¨å•æ•°æ®:', { surname, birthDate, birthTime, gender });
                
                // æ¨¡æ‹Ÿè®¡ç®—å…«å­—
                const bazi = calculateBazi(birthDate, birthTime);
                
                // æ¨¡æ‹Ÿäº”è¡Œåˆ†æ
                const wuxing = analyzeWuxing(bazi);
                
                // æ¨¡æ‹Ÿç”Ÿæˆåå­—
                const names = generateNames(surname, gender, wuxing);
                
                currentResult = {
                    surname,
                    gender,
                    birthDate,
                    birthTime,
                    bazi,
                    wuxing,
                    names
                };
                
                console.log('ç”Ÿæˆçš„ç»“æœ:', currentResult);
                displayResult();
            } catch (error) {
                console.error('generateResult error:', error);
                alert('ç”Ÿæˆç»“æœæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è®¡ç®—å…«å­—ï¼ˆçœŸå®ç®—æ³•ï¼‰
        function calculateBazi(date, time) {
            const heavenly = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const earthly = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            
            const birthDate = new Date(date + 'T' + time);
            const year = birthDate.getFullYear();
            const month = birthDate.getMonth() + 1;
            const day = birthDate.getDate();
            const hour = birthDate.getHours();
            
            // å¹´æŸ±è®¡ç®—ï¼ˆä»¥ç«‹æ˜¥ä¸ºç•Œï¼‰
            let lunarYear = year;
            const springStart = getSpringDate(year);
            if (birthDate < springStart) {
                lunarYear = year - 1;
            }
            
            const yearSky = heavenly[(lunarYear - 4) % 10];
            const yearEarth = earthly[(lunarYear - 4) % 12];
            
            // æœˆæŸ±è®¡ç®—ï¼ˆä»¥èŠ‚æ°”ä¸ºç•Œï¼‰
            const monthIndex = getSolarMonth(birthDate);
            const monthSkyIndex = ((lunarYear - 4) % 10) * 2 + monthIndex;
            const monthSky = heavenly[monthSkyIndex % 10];
            const monthEarth = earthly[(monthIndex + 2) % 12];
            
            // æ—¥æŸ±è®¡ç®—ï¼ˆå„’ç•¥æ—¥ç®—æ³•ï¼‰
            const julianDay = getJulianDay(year, month, day);
            const daySkyIndex = (julianDay - 11) % 10;
            const dayEarthIndex = (julianDay - 11) % 12;
            const daySky = heavenly[daySkyIndex];
            const dayEarth = earthly[dayEarthIndex];
            
            // æ—¶æŸ±è®¡ç®—
            const hourIndex = Math.floor((hour + 1) / 2) % 12;
            const hourSkyIndex = (daySkyIndex * 2 + hourIndex) % 10;
            const hourSky = heavenly[hourSkyIndex];
            const hourEarth = earthly[hourIndex];
            
            return {
                year: yearSky + yearEarth,
                month: monthSky + monthEarth,
                day: daySky + dayEarth,
                hour: hourSky + hourEarth,
                elements: {
                    year: getElementFromStem(yearSky),
                    month: getElementFromStem(monthSky),
                    day: getElementFromStem(daySky),
                    hour: getElementFromStem(hourSky)
                }
            };
        }
        
        // è·å–ç«‹æ˜¥æ—¥æœŸ
        function getSpringDate(year) {
            // ç®€åŒ–è®¡ç®—ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´ç²¾ç¡®çš„èŠ‚æ°”è®¡ç®—
            return new Date(year, 1, 4); // å¤§çº¦2æœˆ4æ—¥
        }
        
        // è·å–èŠ‚æ°”æœˆä»½
        function getSolarMonth(date) {
            const month = date.getMonth();
            const day = date.getDate();
            
            // ç®€åŒ–çš„èŠ‚æ°”è®¡ç®—
            const solarMonths = [11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            let solarMonth = solarMonths[month];
            
            // æ ¹æ®å…·ä½“æ—¥æœŸè°ƒæ•´ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            if ((month === 0 && day < 6) || (month === 11 && day >= 6)) {
                solarMonth = month === 0 ? 11 : 0;
            }
            
            return solarMonth;
        }
        
        // å„’ç•¥æ—¥è®¡ç®—
        function getJulianDay(year, month, day) {
            if (month <= 2) {
                year -= 1;
                month += 12;
            }
            const a = Math.floor(year / 100);
            const b = 2 - a + Math.floor(a / 4);
            return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + b - 1524;
        }
        
        // ä»å¤©å¹²è·å–äº”è¡Œ
        function getElementFromStem(stem) {
            const stemElements = {
                'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
                'ä¸™': 'ç«', 'ä¸': 'ç«',
                'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
                'åºš': 'é‡‘', 'è¾›': 'é‡‘',
                'å£¬': 'æ°´', 'ç™¸': 'æ°´'
            };
            return stemElements[stem] || 'æœ¨';
        }
        
        // äº”è¡Œåˆ†æï¼ˆçœŸå®ç®—æ³•ï¼‰
        function analyzeWuxing(bazi) {
            // ç»Ÿè®¡å…«å­—ä¸­çš„äº”è¡Œ
            const elements = { 'é‡‘': 0, 'æœ¨': 0, 'æ°´': 0, 'ç«': 0, 'åœŸ': 0 };
            
            // ä»å¤©å¹²åˆ†æ
            Object.values(bazi.elements).forEach(element => {
                elements[element]++;
            });
            
            // ä»åœ°æ”¯åˆ†æï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            const branchElements = {
                'å­': 'æ°´', 'äº¥': 'æ°´',
                'å¯…': 'æœ¨', 'å¯': 'æœ¨',
                'å·³': 'ç«', 'åˆ': 'ç«',
                'ç”³': 'é‡‘', 'é…‰': 'é‡‘',
                'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ'
            };
            
            [bazi.year, bazi.month, bazi.day, bazi.hour].forEach(pillar => {
                const branch = pillar[1];
                const element = branchElements[branch];
                if (element) {
                    elements[element]++;
                }
            });
            
            // åˆ†æäº”è¡Œå¼ºå¼±
            const total = Object.values(elements).reduce((sum, count) => sum + count, 0);
            const lacking = [];
            const weak = [];
            const strong = [];
            
            Object.entries(elements).forEach(([element, count]) => {
                const percentage = count / total;
                if (count === 0) {
                    lacking.push(element);
                } else if (percentage < 0.15) {
                    weak.push(element);
                } else if (percentage > 0.3) {
                    strong.push(element);
                }
            });
            
            // ç”Ÿæˆå»ºè®®
            let suggestion = '';
            if (lacking.length > 0) {
                const needElement = lacking[0];
                suggestion = `äº”è¡Œç¼º${lacking.join('ã€')}ï¼Œå»ºè®®é€‰ç”¨${needElement}å­—æ—çš„å­—ï¼Œå¦‚ï¼š${getElementSamples(needElement)}`;
            } else if (weak.length > 0) {
                const needElement = weak[0];
                suggestion = `äº”è¡Œ${weak.join('ã€')}åå¼±ï¼Œå»ºè®®åŠ å¼º${needElement}å­—æ—çš„å­—ï¼Œå¦‚ï¼š${getElementSamples(needElement)}`;
            } else {
                suggestion = 'äº”è¡Œç›¸å¯¹å¹³è¡¡ï¼Œå¯æ ¹æ®éŸ³éŸµç¾æ„Ÿé€‰æ‹©ç”¨å­—';
            }
            
            return { 
                elements, 
                lacking, 
                weak,
                strong,
                suggestion,
                needElement: lacking.length > 0 ? lacking[0] : (weak.length > 0 ? weak[0] : null)
            };
        }
        
        // è·å–äº”è¡Œç”¨å­—ç¤ºä¾‹
        function getElementSamples(element) {
            const samples = {
                'é‡‘': 'é‘«ã€é’°ã€é“­ã€é”ã€é’¢',
                'æœ¨': 'æ—ã€æ£®ã€æ¥ ã€æŸã€æ¡‚', 
                'æ°´': 'æµ·ã€æ±Ÿã€æ¶›ã€æ¶¦ã€æ³½',
                'ç«': 'ç‚ã€ç…œã€çƒ¨ã€ç¿ã€æ™–',
                'åœŸ': 'å¤ã€åœ³ã€åŸã€åŸ¹ã€å ƒ'
            };
            return samples[element] || '';
        }
        
        // ç”Ÿæˆåå­—ï¼ˆç°ä»£åŒ–å¢å¼ºç®—æ³•ï¼‰
        function generateNames(surname, gender, wuxing) {
            try {
                // è·å–å®Œæ•´çš„å­—åº“
                const nameDatabase = getNameDatabase();
                const modernCombos = getModernCombinations();
                const targetElement = wuxing.needElement;
                
                console.log('ç°ä»£å­—åº“å¤§å°:', nameDatabase.length);
                console.log('ç›®æ ‡æ€§åˆ«:', gender);
                console.log('ç›®æ ‡äº”è¡Œ:', targetElement);
                console.log('ç°ä»£ç»„åˆæ•°æ®:', modernCombos);
                
                if (!nameDatabase || nameDatabase.length === 0) {
                    console.error('å­—åº“æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨ç®—æ³•');
                    return generateBackupNames(surname, gender, wuxing);
                }
                
                const nameList = [];
            
            // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šä½¿ç”¨ç°ä»£æµè¡Œç»„åˆ
            if (modernCombos[gender]) {
                console.log('å°è¯•ç°ä»£æµè¡Œç»„åˆ...');
                for (const combo of modernCombos[gender]) {
                    const char1Data = nameDatabase.find(c => c.char === combo[0]);
                    const char2Data = nameDatabase.find(c => c.char === combo[1]);
                    
                    if (char1Data && char2Data) {
                        const name = char1Data.char + char2Data.char;
                        const fullName = surname + name;
                        
                        // è®¡ç®—è¯„åˆ†ï¼ˆç°ä»£ç»„åˆè‡ªåŠ¨åŠ åˆ†ï¼‰
                        const score = calculateModernNameScore(surname, name, wuxing, char1Data, char2Data, true);
                        
                        nameList.push({
                            name,
                            fullName,
                            meaning: generateModernMeaning(char1Data, char2Data),
                            score,
                            wuxing: char1Data.element + char2Data.element,
                            isTop: false,
                            strokes: char1Data.strokes + char2Data.strokes,
                            style: combineStyles(char1Data.style, char2Data.style),
                            pinyin: generatePinyin(surname, char1Data, char2Data),
                            isModern: true
                        });
                    }
                }
            }
            
            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ™ºèƒ½ç”Ÿæˆç°ä»£é£æ ¼ç»„åˆ
            console.log('æ™ºèƒ½ç”Ÿæˆç°ä»£ç»„åˆ...');
            const modernChars = nameDatabase.filter(char => {
                // ä¼˜å…ˆé€‰æ‹©ç°ä»£é£æ ¼çš„å­—
                const modernStyles = ['modern', 'elegant', 'fresh', 'gentle', 'joyful', 'dreamy'];
                return (char.gender.includes(gender) || char.gender.includes('both')) &&
                       (char.style && modernStyles.includes(char.style));
            });
            
            // å¦‚æœç°ä»£é£æ ¼å­—ç¬¦ä¸å¤Ÿï¼Œæ·»åŠ æ‰€æœ‰æ€§åˆ«é€‚åˆçš„å­—ç¬¦
            if (modernChars.length < 20) {
                const allGenderChars = nameDatabase.filter(char => 
                    char.gender.includes(gender) || char.gender.includes('both')
                );
                modernChars.push(...allGenderChars.filter(char => !modernChars.includes(char)));
            }
            
            // äº”è¡Œè¡¥å¼ºå­—ç¬¦
            const elementChars = targetElement ? 
                nameDatabase.filter(char => 
                    char.element === targetElement && 
                    (char.gender.includes(gender) || char.gender.includes('both'))
                ) : [];
            
            // åˆå¹¶å­—ç¬¦æ± 
            let allCandidates = [...modernChars];
            if (elementChars.length > 0) {
                // äº”è¡ŒåŒ¹é…çš„å­—å¢åŠ æƒé‡
                allCandidates = allCandidates.concat(elementChars).concat(elementChars);
            }
            
            // ç”Ÿæˆæ™ºèƒ½ç»„åˆ
            const maxAttempts = Math.min(allCandidates.length * 20, 300);
            for (let attempt = 0; attempt < maxAttempts && nameList.length < 30; attempt++) {
                const char1 = allCandidates[Math.floor(Math.random() * allCandidates.length)];
                const char2 = allCandidates[Math.floor(Math.random() * allCandidates.length)];
                
                if (char1.char === char2.char) continue;
                
                const name = char1.char + char2.char;
                
                // æ£€æŸ¥é‡å¤
                if (nameList.some(existing => existing.name === name)) continue;
                
                // ç°ä»£åŒ–å’Œè°åº¦æ£€æŸ¥
                if (!isModernHarmoniousName(char1, char2, gender)) continue;
                
                const fullName = surname + name;
                const score = calculateModernNameScore(surname, name, wuxing, char1, char2, false);
                
                nameList.push({
                    name,
                    fullName,
                    meaning: generateModernMeaning(char1, char2),
                    score,
                    wuxing: char1.element + char2.element,
                    isTop: false,
                    strokes: char1.strokes + char2.strokes,
                    style: combineStyles(char1.style, char2.style),
                    pinyin: generatePinyin(surname, char1, char2),
                    isModern: false
                });
            }
            
            // æŒ‰è¯„åˆ†æ’åºï¼Œç°ä»£ç»„åˆä¼˜å…ˆ
            nameList.sort((a, b) => {
                if (a.isModern && !b.isModern) return -1;
                if (!a.isModern && b.isModern) return 1;
                return b.score - a.score;
            });
            
            // æ ‡è®°æœ€ä½³åå­—
            nameList.forEach((name, index) => {
                name.isTop = index === 0;
            });
            
            console.log('ç”Ÿæˆçš„åå­—æ•°é‡:', nameList.length);
            return nameList.slice(0, 5);
            } catch (error) {
                console.error('ç”Ÿæˆåå­—æ—¶å‡ºé”™:', error);
                return generateBackupNames(surname, gender, wuxing);
            }
        }
        
        // ç°ä»£åŒ–åå­—è¯„åˆ†ç³»ç»Ÿ
        function calculateModernNameScore(surname, name, wuxing, char1, char2, isPresetCombo) {
            let score = 70; // åŸºç¡€åˆ†
            
            // ç°ä»£é¢„è®¾ç»„åˆåŠ åˆ†
            if (isPresetCombo) score += 15;
            
            // é£æ ¼åŠ åˆ†
            const modernStyles = ['modern', 'elegant', 'fresh', 'gentle', 'joyful', 'dreamy'];
            if (char1.style && modernStyles.includes(char1.style)) score += 5;
            if (char2.style && modernStyles.includes(char2.style)) score += 5;
            
            // äº”è¡ŒåŒ¹é…åŠ åˆ†
            if (wuxing.needElement) {
                if (char1.element === wuxing.needElement) score += 8;
                if (char2.element === wuxing.needElement) score += 8;
            }
            
            // å­—éŸ³éŸµå¾‹åŠ åˆ†
            const phonetics = analyzePhonetics(surname + name);
            if (phonetics.includes('é¡ºå£')) score += 5;
            if (phonetics.includes('å“äº®')) score += 3;
            
            // ç¬”ç”»æ•°é€‚ä¸­åŠ åˆ†
            const totalStrokes = char1.strokes + char2.strokes;
            if (totalStrokes >= 12 && totalStrokes <= 25) score += 5;
            
            // é¿å…è€æ°”å­—ç¬¦æ‰£åˆ†
            const oldStyleChars = ['ç¦', 'è´µ', 'è´¢', 'å¯Œ', 'åº·', 'å¯¿', 'å¾·', 'ä»', 'ä¹‰', 'ç¤¼'];
            if (oldStyleChars.includes(char1.char)) score -= 10;
            if (oldStyleChars.includes(char2.char)) score -= 10;
            
            // ç°ä»£æµè¡Œå­—ç¬¦åŠ åˆ†
            const trendyChars = ['æ¢“', 'æ¶µ', 'è±', 'æ±', 'æ™¨', 'ç…œ', 'ç¿', 'ç³', 'è¯—', 'è¯­'];
            if (trendyChars.includes(char1.char)) score += 6;
            if (trendyChars.includes(char2.char)) score += 6;
            
            return Math.min(score, 100);
        }
        
        // ç°ä»£åŒ–å’Œè°åº¦æ£€æŸ¥
        function isModernHarmoniousName(char1, char2, gender) {
            // é¿å…è€æ°”ç»„åˆ
            const oldCombos = [
                ['ç¦', 'è´µ'], ['å¯Œ', 'è´µ'], ['åº·', 'å®'], ['å¾·', 'ä¹‰'], ['ä»', 'å¾·'],
                ['å¿—', 'å¼º'], ['å»º', 'å›½'], ['çˆ±', 'å›½'], ['å›½', 'å¼º'], ['å»º', 'å†›']
            ];
            
            for (const combo of oldCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return false;
                }
            }
            
            // ç°ä»£æ¨èç»„åˆ
            const modernCombos = {
                'male': [
                    ['å®‡', 'è½©'], ['æµ©', 'ç„¶'], ['æ¢“', 'è½©'], ['å­', 'æ¶µ'], ['ä¿Š', 'ç†™'],
                    ['ç…œ', 'ç¥º'], ['ç¿', 'æ³½'], ['æ˜', 'è½©'], ['åš', 'æ–‡'], ['å‡¯', 'ç„¶']
                ],
                'female': [
                    ['é›¨', 'æ¡'], ['è¯—', 'æ¶µ'], ['è¯­', 'æ±'], ['æ²', 'æ™´'], ['æ€', 'é›…'],
                    ['æ¢“', 'è±'], ['è‹¥', 'æ±'], ['ç¾', 'ç³'], ['é™', 'é›…'], ['è‰¾', 'ç³']
                ]
            };
            
            const genderCombos = modernCombos[gender] || [];
            for (const combo of genderCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return true;
                }
            }
            
            // æ£€æŸ¥é£æ ¼åŒ¹é…
            const compatibleStyles = {
                'modern': ['elegant', 'fresh', 'bright'],
                'elegant': ['gentle', 'peaceful', 'noble'],
                'fresh': ['joyful', 'natural', 'pure'],
                'gentle': ['peaceful', 'tender', 'dreamy']
            };
            
            const style1Compat = compatibleStyles[char1.style || 'classic'] || [];
            if (style1Compat.includes(char2.style) || char1.style === char2.style) {
                return true;
            }
            
            return Math.random() > 0.7; // 30%çš„æœºä¼šæ¥å—å…¶ä»–ç»„åˆ
        }
        
        // ç”Ÿæˆç°ä»£åŒ–å¯“æ„
        function generateModernMeaning(char1, char2) {
            const style1 = char1.style || 'classic';
            const style2 = char2.style || 'classic';
            
            const styleDescriptions = {
                'modern': 'æ—¶å°šç°ä»£ï¼Œä¸æ—¶ä¿±è¿›',
                'elegant': 'ä¼˜é›…é«˜è´µï¼Œæ°”è´¨å‡ºä¼—', 
                'fresh': 'æ¸…æ–°è‡ªç„¶ï¼Œæœæ°”è“¬å‹ƒ',
                'gentle': 'æ¸©æŸ”å¦‚æ°´ï¼ŒæŸ”æƒ…ä¼¼æ°´',
                'joyful': 'æ¬¢ä¹å–œæ‚¦ï¼Œå¼€æœ—æ´»æ³¼',
                'dreamy': 'æ¢¦å¹»æµªæ¼«ï¼Œå……æ»¡æƒ³è±¡'
            };
            
            const desc1 = styleDescriptions[style1] || 'å“å¾·é«˜å°š';
            const desc2 = styleDescriptions[style2] || 'æ‰åå‡ºä¼—';
            
            return `${char1.char}å¯“æ„${char1.meaning.split('ï¼Œ')[0]}ï¼Œ${char2.char}å¯“æ„${char2.meaning.split('ï¼Œ')[0]}ã€‚æ•´ä½“${desc1}ï¼Œ${desc2}ï¼Œæ˜¯ç°ä»£çˆ¶æ¯çš„ç†æƒ³é€‰æ‹©ã€‚`;
        }
        
        // ç»„åˆé£æ ¼
        function combineStyles(style1, style2) {
            if (style1 === style2) return style1;
            
            const combinations = {
                'modern_elegant': 'ç°ä»£ä¼˜é›…',
                'elegant_gentle': 'ä¼˜é›…æ¸©æŸ”', 
                'fresh_joyful': 'æ¸…æ–°æ¬¢å¿«',
                'gentle_dreamy': 'æ¸©æŸ”æ¢¦å¹»',
                'modern_fresh': 'ç°ä»£æ¸…æ–°',
                'elegant_dreamy': 'ä¼˜é›…æ¢¦å¹»'
            };
            
            const key = [style1, style2].sort().join('_');
            return combinations[key] || 'å’Œè°æ­é…';
        }
        
        // å¤‡ç”¨èµ·åç®—æ³•ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function generateBackupNames(surname, gender, wuxing) {
            console.log('ä½¿ç”¨å¤‡ç”¨èµ·åç®—æ³•');
            const backupNames = {
                male: [
                    { name: 'å®‡è½©', score: 95, meaning: 'å®‡å®™å¹¿é˜”ï¼Œæ°”å®‡è½©æ˜‚ï¼Œå¯“æ„èƒ¸è¥Ÿå¼€é˜”ï¼Œé£åº¦ç¿©ç¿©' },
                    { name: 'æµ©ç„¶', score: 92, meaning: 'æµ©ç„¶æ­£æ°”ï¼Œåˆšæ­£ä¸é˜¿ï¼Œå¯“æ„å“æ ¼é«˜å°šï¼Œæ­£ç›´å–„è‰¯' },
                    { name: 'å­æ¶µ', score: 90, meaning: 'æ‰å­ä½³äººï¼Œæ¶µå…»æ·±åšï¼Œå¯“æ„æ‰åæ¨ªæº¢ï¼Œä¿®å…»æä½³' },
                    { name: 'ä¿Šç†™', score: 88, meaning: 'ä¿Šæœ—è‹±ä¿Šï¼Œç†™ç†™èèï¼Œå¯“æ„è‹±ä¿Šæ½‡æ´’ï¼Œå‰ç¨‹å…‰æ˜' },
                    { name: 'æ¢“è½©', score: 86, meaning: 'æ¢“æè‰¯æœ¨ï¼Œè½©æ˜‚æ°”å®‡ï¼Œå¯“æ„æˆæ‰æœ‰æœ›ï¼Œæ°”åº¦ä¸å‡¡' }
                ],
                female: [
                    { name: 'é›¨æ¡', score: 95, meaning: 'ç»†é›¨æ¢§æ¡ï¼Œæ¸…æ–°é›…è‡´ï¼Œå¯“æ„æ¸©æŸ”å¦‚æ°´ï¼Œé«˜é›…è„±ä¿—' },
                    { name: 'è¯—æ¶µ', score: 92, meaning: 'è¯—æƒ…ç”»æ„ï¼Œæ¶µå…»æ·±åšï¼Œå¯“æ„æ‰åæ¨ªæº¢ï¼Œä¹¦é¦™é—¨ç¬¬' },
                    { name: 'è¯­æ±', score: 90, meaning: 'è¯­è¨€ä¼˜ç¾ï¼Œæ±æ°´è½»æŸ”ï¼Œå¯“æ„æ‰æ€æ•æ·ï¼Œæ¸©æŸ”å¯äºº' },
                    { name: 'æ²æ™´', score: 88, meaning: 'æ²æµ´é˜³å…‰ï¼Œæ™´ç©ºä¸‡é‡Œï¼Œå¯“æ„é˜³å…‰å¼€æœ—ï¼Œå¿ƒæƒ…æ„‰æ‚¦' },
                    { name: 'æ€é›…', score: 86, meaning: 'æ€ç»´æ•æ·ï¼Œé«˜é›…è„±ä¿—ï¼Œå¯“æ„èªæ…§è¿‡äººï¼Œå“å‘³ä¸å‡¡' }
                ]
            };
            
            const genderNames = backupNames[gender] || backupNames.male;
            return genderNames.map((nameData, index) => ({
                name: nameData.name,
                fullName: surname + nameData.name,
                meaning: nameData.meaning,
                score: nameData.score,
                wuxing: 'æœ¨ç«',
                isTop: index === 0,
                strokes: 20,
                style: 'ç°ä»£ä¼˜é›…',
                pinyin: `${surname} ${nameData.name.charAt(0)} ${nameData.name.charAt(1)}`,
                isModern: true
            }));
        }
        
        // è·å–ç°ä»£ç»„åˆ
        function getModernCombinations() {
            if (typeof MODERN_COMBINATIONS !== 'undefined') {
                return MODERN_COMBINATIONS;
            } else {
                // å¤‡ç”¨ç°ä»£ç»„åˆ
                return {
                    male: [
                        ['å®‡', 'è½©'], ['æµ©', 'ç„¶'], ['å­', 'è½©'], ['æ¢“', 'è½©'], 
                        ['ä¿Š', 'ç†™'], ['ç…œ', 'ç¥º'], ['ç¿', 'æ³½'], ['æ˜', 'è½©']
                    ],
                    female: [
                        ['é›¨', 'æ¡'], ['è¯—', 'æ¶µ'], ['è¯­', 'æ±'], ['æ²', 'æ™´'],
                        ['æ€', 'é›…'], ['æ¢“', 'è±'], ['è‹¥', 'æ±'], ['ç¾', 'ç³']
                    ]
                };
            }
        }
        
        // æ•°ç»„éšæœºæ‰“ä¹±å‡½æ•°
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // ç”Ÿæˆæ‹¼éŸ³å‡½æ•°
        function generatePinyin(surname, char1, char2) {
            // å¸¸è§å§“æ°æ‹¼éŸ³æ˜ å°„
            const surnameMap = {
                'å¼ ': 'zhÄng', 'ç‹': 'wÃ¡ng', 'æ': 'lÇ', 'åˆ˜': 'liÃº', 'é™ˆ': 'chÃ©n', 
                'æ¨': 'yÃ¡ng', 'èµµ': 'zhÃ o', 'é»„': 'huÃ¡ng', 'å‘¨': 'zhÅu', 'å´': 'wÃº',
                'å¾': 'xÃº', 'å­™': 'sÅ«n', 'èƒ¡': 'hÃº', 'æœ±': 'zhÅ«', 'é«˜': 'gÄo',
                'æ—': 'lÃ­n', 'ä½•': 'hÃ©', 'éƒ­': 'guÅ', 'é©¬': 'mÇ', 'ç½—': 'luÃ³',
                'æ¢': 'liÃ¡ng', 'å®‹': 'sÃ²ng', 'éƒ‘': 'zhÃ¨ng', 'è°¢': 'xiÃ¨', 'éŸ©': 'hÃ¡n',
                'å”': 'tÃ¡ng', 'å†¯': 'fÃ©ng', 'äº': 'yÃº', 'è‘£': 'dÇ’ng', 'è§': 'xiÄo'
            };
            
            const surnamePin = surnameMap[surname] || surname;
            const char1Pin = char1.pinyin || char1.char;
            const char2Pin = char2.pinyin || char2.char;
            
            return `${surnamePin} ${char1Pin} ${char2Pin}`;
        }
        
        // æ£€æŸ¥åå­—ç»„åˆå’Œè°åº¦
        function isHarmoniousNameCombination(char1, char2, gender) {
            // é¿å…äº”è¡Œç›¸å…‹çš„ç»„åˆ
            const conflictElements = {
                'é‡‘': ['æœ¨'],
                'æœ¨': ['åœŸ'],
                'åœŸ': ['æ°´'],
                'æ°´': ['ç«'],
                'ç«': ['é‡‘']
            };
            
            if (conflictElements[char1.element] && conflictElements[char1.element].includes(char2.element)) {
                return false;
            }
            
            // æ¨èçš„ç¾å¥½ç»„åˆï¼ˆæŒ‰æ€§åˆ«ä¼˜åŒ–ï¼‰
            const harmoniousCombos = {
                'male': [
                    // ç”·ç”Ÿæ¨èç»„åˆï¼šåŠ›é‡ã€æ™ºæ…§ã€æˆåŠŸç±»
                    ['å®‡', 'è½©'], ['æµ©', 'ç„¶'], ['ä¿Š', 'æ°'], ['åš', 'æ–‡'], ['å¿—', 'å¼º'],
                    ['é“­', 'è½©'], ['ç¿', 'å®‡'], ['ç…œ', 'è¾°'], ['å³°', 'æ¶›'], ['æ‰¿', 'å¾·'],
                    ['æ€', 'è¿œ'], ['æ˜', 'è½©'], ['é”', 'å³°'], ['å®¸', 'æ˜Š'], ['æ™º', 'å‹‡']
                ],
                'female': [
                    // å¥³ç”Ÿæ¨èç»„åˆï¼šç¾ä¸½ã€ä¼˜é›…ã€æ™ºæ…§ç±»
                    ['é›…', 'ç³'], ['è¯—', 'æ¶µ'], ['å©·', 'é›¯'], ['æ…§', 'çª'], ['ç¾', 'ç³'],
                    ['æ€', 'é›…'], ['æ¢¦', 'ç‘¶'], ['è¯—', 'å©·'], ['é›¨', 'è±'], ['æ™´', 'é›ª'],
                    ['é¢–', 'æ…§'], ['é™', 'é›…'], ['ç¾', 'å¨œ'], ['ç³', 'å¨œ'], ['é›…', 'æ¬£']
                ]
            };
            
            const genderCombos = harmoniousCombos[gender] || [];
            for (const combo of genderCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return true;
                }
            }
            
            // æ£€æŸ¥å­—ç¬¦å«ä¹‰æ­é…æ˜¯å¦å’Œè°
            const negativeKeywords = ['ç—…', 'æ­»', 'å‡¶', 'æ¶', 'è¡°', 'è´¥', 'ç©·', 'è‹¦'];
            for (const keyword of negativeKeywords) {
                if (char1.meaning.includes(keyword) || char2.meaning.includes(keyword)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // è·å–å­—åº“æ•°æ®
        function getNameDatabase() {
            // ä½¿ç”¨å¤–éƒ¨å­—åº“æ–‡ä»¶ä¸­çš„æ•°æ®
            return typeof NAME_DATABASE !== 'undefined' ? NAME_DATABASE : [];
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult() {
            console.log('å¼€å§‹æ˜¾ç¤ºç»“æœ...');
            try {
                // æ˜¾ç¤ºå…«å­—ä¿¡æ¯
                const baziInfo = document.getElementById('baziInfo');
            baziInfo.innerHTML = `
                <div>å‡ºç”Ÿæ—¥æœŸï¼š${currentResult.birthDate}</div>
                <div>å‡ºç”Ÿæ—¶é—´ï¼š${currentResult.birthTime}</div>
                <div>å¹´æŸ±ï¼š${currentResult.bazi.year}</div>
                <div>æœˆæŸ±ï¼š${currentResult.bazi.month}</div>
                <div>æ—¥æŸ±ï¼š${currentResult.bazi.day}</div>
                <div>æ—¶æŸ±ï¼š${currentResult.bazi.hour}</div>
            `;
            
            // æ˜¾ç¤ºäº”è¡Œåˆ†æ
            const wuxingAnalysis = document.getElementById('wuxingAnalysis');
            let wuxingHtml = '';
            Object.entries(currentResult.wuxing.elements).forEach(([element, count]) => {
                const stars = 'â˜…'.repeat(count) + 'â˜†'.repeat(4 - count);
                wuxingHtml += `
                    <div class="wuxing-item">
                        <span class="wuxing-name">${element}ï¼š</span>
                        <span class="wuxing-stars">${stars}</span>
                    </div>
                `;
            });
            wuxingHtml += `<p style="margin-top: 15px; color: #666; font-size: 14px;">${currentResult.wuxing.suggestion}</p>`;
            wuxingAnalysis.innerHTML = wuxingHtml;
            
            // æ˜¾ç¤ºæ¨èåå­—
            const nameResults = document.getElementById('nameResults');
            let namesHtml = '';
            currentResult.names.forEach((name, index) => {
                const stars = 'â­'.repeat(Math.floor(name.score / 20));
                const complementInfo = currentResult.wuxing.needElement ? `ï¼Œè¡¥${currentResult.wuxing.needElement}å¼ºè¿` : '';
                
                // ç°ä»£åŒ–æ ‡è¯†
                const modernBadge = name.isModern ? '<span class="modern-badge">ğŸ¯ æµè¡Œæ¨è</span>' : '';
                const styleBadge = name.style ? `<span class="style-badge">ğŸ’« ${name.style}</span>` : '';
                
                namesHtml += `
                    <div class="name-card ${name.isTop ? 'best' : ''} ${name.isModern ? 'modern-combo' : ''}">
                        <div class="name-header">
                            <div class="name-text">ã€${name.fullName}ã€‘</div>
                            <div class="name-score">${name.score}åˆ†</div>
                        </div>
                        <div class="name-badges">
                            ${modernBadge}
                            ${styleBadge}
                        </div>
                        <div class="name-pinyin">ğŸ“ æ‹¼éŸ³ï¼š${name.pinyin}</div>
                        <div class="name-stars">${stars}</div>
                        <div class="name-meaning">ğŸ“– ${name.meaning}</div>
                        <div class="name-wuxing">ğŸ”¥ äº”è¡Œï¼š${name.wuxing}${complementInfo}</div>
                        <div class="name-wuxing">âœï¸ ç¬”ç”»ï¼š${name.strokes}ç”»</div>
                        <div class="name-wuxing">ğŸµ éŸ³éŸµï¼š${analyzePhonetics(name.fullName)}</div>
                    </div>
                `;
            });
            nameResults.innerHTML = namesHtml;
            
            showSection('resultSection');
            console.log('ç»“æœæ˜¾ç¤ºå®Œæˆ');
            } catch (error) {
                console.error('displayResult error:', error);
                alert('æ˜¾ç¤ºç»“æœæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åˆ‡æ¢æ˜¾ç¤ºçš„é¡µé¢
        function showSection(sectionId) {
            console.log('åˆ‡æ¢åˆ°é¡µé¢:', sectionId);
            try {
                const sections = ['formSection', 'loadingSection', 'resultSection'];
                
                // éšè—æ‰€æœ‰é¡µé¢
                sections.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        element.style.opacity = '0';
                    }
                });
                
                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.style.display = 'block';
                    targetSection.style.visibility = 'visible';
                    targetSection.style.opacity = '1';
                    targetSection.style.position = 'relative';
                    targetSection.style.left = 'auto';
                    console.log('æˆåŠŸæ˜¾ç¤ºé¡µé¢:', sectionId);
                } else {
                    console.error('æ‰¾ä¸åˆ°ç›®æ ‡é¡µé¢:', sectionId);
                }
            } catch (error) {
                console.error('showSection error:', error);
            }
        }
        
        // åˆ†äº«ç»“æœ
        function shareResult() {
            if (!currentResult) return;
            
            const shareText = `æˆ‘ç»™å®å®ç”¨AIèµ·äº†ä¸ªå¥½åå­—ï¼š${currentResult.names[0].fullName}ï¼Œç»¼åˆè¯„åˆ†${currentResult.names[0].score}åˆ†ï¼\n\nä¼ æ‰¿åƒå¹´å‘½ç†æ™ºæ…§ï¼ŒAIç§‘å­¦èµ·å¥½å\nğŸ‘¶ ä½ ä¹Ÿæƒ³ç»™å®å®èµ·ä¸ªå¥½åå­—å—ï¼Ÿ`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'å®å®æ™ºèƒ½èµ·åç¥å™¨',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    alert('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¿«å»æœ‹å‹åœˆåˆ†äº«å§ï¼');
                });
            }
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('namingForm').reset();
            document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
            selectedGender = '';
            currentResult = null;
            
            // é‡æ–°è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
            
            showSection('formSection');
        }
        
        // è®¡ç®—åå­—è¯„åˆ†
        function calculateNameScore(surname, name, wuxing) {
            let score = 0;
            
            // 1. äº”è¡ŒåŒ¹é…åº¦ (40åˆ†)
            if (wuxing.needElement) {
                const nameDatabase = getNameDatabase();
                const nameChars = name.split('');
                let matchCount = 0;
                
                nameChars.forEach(char => {
                    const charData = nameDatabase.find(c => c.char === char);
                    if (charData && charData.element === wuxing.needElement) {
                        matchCount++;
                    }
                });
                
                score += (matchCount / nameChars.length) * 40;
            } else {
                score += 35; // äº”è¡Œå¹³è¡¡æ—¶ç»™åŸºç¡€åˆ†
            }
            
            // 2. ç¬”ç”»æ•°ç† (25åˆ†)
            const strokeScore = calculateStrokeScore(surname, name);
            score += strokeScore;
            
            // 3. éŸ³éŸµç¾æ„Ÿ (20åˆ†)
            const phoneticScore = calculatePhoneticScore(surname + name);
            score += phoneticScore;
            
            // 4. å¯“æ„å‰ç¥¥ (15åˆ†)
            const meaningScore = calculateMeaningScore(name);
            score += meaningScore;
            
            return Math.round(score);
        }
        
        // è®¡ç®—ç¬”ç”»æ•°ç†è¯„åˆ†
        function calculateStrokeScore(surname, name) {
            const nameDatabase = getNameDatabase();
            const surnameStrokes = getCharStrokes(surname);
            
            let totalStrokes = surnameStrokes;
            name.split('').forEach(char => {
                const charData = nameDatabase.find(c => c.char === char);
                totalStrokes += charData ? charData.strokes : 10;
            });
            
            // æ ¹æ®æ€»ç¬”ç”»æ•°åˆ¤æ–­å‰å‡¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            const luckyNumbers = [1, 3, 5, 6, 7, 8, 11, 13, 15, 16, 17, 18, 21, 23, 24, 25, 29, 31, 32, 33, 35, 37, 39, 41, 45, 47, 48, 52, 57, 61, 63, 65, 67, 68, 81];
            
            if (luckyNumbers.includes(totalStrokes % 81)) {
                return 25;
            } else if (totalStrokes % 81 < 40) {
                return 15;
            } else {
                return 10;
            }
        }
        
        // è·å–å•å­—ç¬”ç”»æ•°
        function getCharStrokes(char) {
            const commonStrokes = {
                'ç‹': 4, 'æ': 7, 'å¼ ': 11, 'åˆ˜': 15, 'é™ˆ': 16, 'æ¨': 13, 'èµµ': 14, 'é»„': 12, 'å‘¨': 8, 'å´': 7,
                'å¾': 10, 'å­™': 6, 'èƒ¡': 9, 'æœ±': 6, 'é«˜': 10, 'æ—': 8, 'ä½•': 7, 'éƒ­': 15, 'é©¬': 10, 'ç½—': 19,
                'æ¢': 11, 'å®‹': 7, 'éƒ‘': 19, 'è°¢': 17, 'éŸ©': 17, 'å”': 10, 'å†¯': 12, 'äº': 3, 'è‘£': 15, 'è§': 18
            };
            return commonStrokes[char] || 8; // é»˜è®¤8ç”»
        }
        
        // è®¡ç®—éŸ³éŸµè¯„åˆ†
        function calculatePhoneticScore(fullName) {
            const tones = getTonesPattern(fullName);
            
            // æ£€æŸ¥å£°è°ƒæ­é…æ˜¯å¦å’Œè°
            if (tones.length >= 3) {
                // é¿å…ä¸‰ä¸ªå­—éƒ½æ˜¯åŒä¸€å£°è°ƒ
                if (tones[0] === tones[1] && tones[1] === tones[2]) {
                    return 10;
                }
                // å¹³ä»„ç›¸é—´æ¯”è¾ƒå¥½å¬
                if ((tones[0] !== tones[1]) && (tones[1] !== tones[2])) {
                    return 20;
                }
                return 15;
            }
            return 12;
        }
        
        // è·å–å­—çš„å£°è°ƒï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function getTonesPattern(name) {
            const toneMap = {
                // ä¸€å£°ï¼ˆé˜´å¹³ï¼‰
                'å¼ ': 1, 'ç‹': 2, 'æ': 3, 'åˆ˜': 2, 'é™ˆ': 2, 'æ¨': 2, 'å‘¨': 1, 'å´': 2,
                'é‘«': 1, 'é’°': 4, 'æ—': 2, 'æµ·': 3, 'ç‚': 2, 'å¤': 1,
                'è½©': 1, 'ç¿': 4, 'æ¶µ': 2, 'è¯—': 1, 'é›¨': 3, 'æ‚¦': 4
            };
            
            return name.split('').map(char => toneMap[char] || 2);
        }
        
        // è®¡ç®—å¯“æ„è¯„åˆ†
        function calculateMeaningScore(name) {
            const positiveChars = ['é‘«', 'é’°', 'æ—', 'æµ·', 'ç‚', 'å¤', 'è½©', 'ç¿', 'æ¶µ', 'è¯—', 'é›¨', 'æ‚¦', 'é›…', 'çª', 'ç‘¶', 'æ…§', 'å®‡', 'è¾°', 'æ™¨'];
            let score = 0;
            
            name.split('').forEach(char => {
                if (positiveChars.includes(char)) {
                    score += 7.5;
                } else {
                    score += 5;
                }
            });
            
            return Math.min(score, 15);
        }
        
        // éŸ³éŸµåˆ†æ
        function analyzePhonetics(fullName) {
            const tones = getTonesPattern(fullName);
            const toneNames = ['', 'å¹³å£°', 'ä¸Šå£°', 'å»å£°', 'å…¥å£°'];
            
            let pattern = tones.map(tone => toneNames[tone] || 'å¹³å£°').join('-');
            
            // åˆ¤æ–­éŸ³éŸµç‰¹ç‚¹
            let analysis = '';
            if (tones.every(tone => tone === tones[0])) {
                analysis = 'å£°è°ƒç»Ÿä¸€ï¼ŒéŸ³éŸµå¹³ç¨³';
            } else if (tones[0] !== tones[1] && tones[1] !== tones[2]) {
                analysis = 'å¹³ä»„ç›¸é—´ï¼Œæœ—æœ—ä¸Šå£';
            } else {
                analysis = 'éŸ³è°ƒå’Œè°ï¼Œæ‚¦è€³åŠ¨å¬';
            }
            
            return { pattern, analysis };
        }
    </script>
</body>
</html> 