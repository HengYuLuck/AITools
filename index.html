<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>宝宝智能起名神器 - AI科学起好名</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 414px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .stats {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .form-section {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #D32F2F;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }
        
        .gender-group {
            display: flex;
            gap: 12px;
        }
        
        .gender-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .gender-option.active {
            border-color: #D32F2F;
            background: #D32F2F;
            color: white;
        }
        
        .datetime-group {
            display: flex;
            gap: 12px;
        }
        
        .datetime-input {
            flex: 1;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #D32F2F 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-section {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D32F2F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            width: 200px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #D32F2F, #FF6B6B);
            border-radius: 3px;
            animation: progress 3s ease-in-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .result-section {
            padding: 20px;
        }
        
        .bazi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .bazi-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .bazi-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .wuxing-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .wuxing-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .wuxing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .wuxing-name {
            font-weight: 600;
        }
        
        .wuxing-stars {
            color: #FFD700;
        }
        
        .name-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .name-card.best {
            border-color: #D32F2F;
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
            position: relative;
        }
        
        .name-card.best::before {
            content: '⭐ 最佳推荐';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #D32F2F;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .name-card.modern-combo {
            border-left: 4px solid #4ecdc4;
            background: linear-gradient(135deg, #f0ffff 0%, #ffffff 100%);
        }
        
        .name-badges {
            margin: 8px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .modern-badge {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .style-badge {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .name-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .name-text {
            font-size: 24px;
            font-weight: bold;
            color: #D32F2F;
        }
        
        .name-score {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
        }
        
        .name-pinyin {
            font-size: 13px;
            color: #666;
            margin: 5px 0;
            font-style: italic;
        }
        
        .name-stars {
            color: #FFD700;
            font-size: 18px;
            margin: 5px 0;
        }
        
        .name-meaning {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .name-wuxing {
            font-size: 13px;
            color: #888;
        }
        
        .share-section {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .share-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .retry-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            color: #D32F2F;
            border: 2px solid #D32F2F;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 首页表单 -->
        <div id="formSection" class="form-page">
            <div class="header">
                <div class="header-content">
                    <h1 class="title">🏮 宝宝智能起名神器 🏮</h1>
                    <p class="subtitle">传承千年命理智慧，AI科学起好名</p>
                    <p class="stats">💫 已为 100万+ 宝宝起名成功</p>
                </div>
            </div>
            
            <div class="form-section">
                <form id="namingForm">
                    <div class="form-group">
                        <label class="form-label">👶 宝宝姓氏</label>
                        <input type="text" class="form-input" id="surname" placeholder="请输入姓氏，如：张" maxlength="2" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">👦👧 宝宝性别</label>
                        <div class="gender-group">
                            <div class="gender-option" data-gender="male">👦 男宝</div>
                            <div class="gender-option" data-gender="female">👧 女宝</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">📅 出生日期</label>
                        <div class="datetime-group">
                            <input type="date" class="form-input datetime-input" id="birthDate" required>
                            <input type="time" class="form-input datetime-input" id="birthTime" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">🎯 立即免费起名</button>
                </form>
            </div>
        </div>
        
        <!-- 分析页面 -->
        <div id="loadingSection" class="loading-section hidden">
            <div class="loading-icon"></div>
            <div class="loading-text" id="loadingText">🔮 正在为您的宝宝分析...</div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
        
        <!-- 结果页面 -->
        <div id="resultSection" class="result-section hidden">
            <div class="bazi-card">
                <div class="bazi-title">📅 宝宝命理信息</div>
                <div class="bazi-info" id="baziInfo">
                    <!-- 八字信息将在这里动态生成 -->
                </div>
            </div>
            
            <div class="wuxing-card">
                <div class="wuxing-title">🔥 五行分析</div>
                <div id="wuxingAnalysis">
                    <!-- 五行分析将在这里动态生成 -->
                </div>
            </div>
            
            <div id="nameResults">
                <!-- 推荐名字将在这里动态生成 -->
            </div>
            
            <div class="share-section">
                <button class="share-btn" onclick="shareResult()">📤 分享到朋友圈</button>
                <button class="retry-btn" onclick="resetForm()">🔄 再起一个名字</button>
            </div>
        </div>
    </div>

    <!-- 引入字库数据 -->
    <script src="nameDatabase.js"></script>
    <script src="expandDatabase.js"></script>
    <script>
        // 全局变量
        let selectedGender = '';
        let currentResult = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 确保页面状态正确 - 只显示表单页面
            showSection('formSection');
            
            initForm();
            
            // 设置默认日期为今天
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
        });
        
        // 初始化表单
        function initForm() {
            // 性别选择
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    selectedGender = this.dataset.gender;
                });
            });
            
            // 表单提交
            document.getElementById('namingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    startNaming();
                }
            });
        }
        
        // 表单验证
        function validateForm() {
            const surname = document.getElementById('surname').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            
            if (!surname) {
                alert('请输入宝宝姓氏');
                return false;
            }
            
            if (!selectedGender) {
                alert('请选择宝宝性别');
                return false;
            }
            
            if (!birthDate || !birthTime) {
                alert('请选择出生日期和时间');
                return false;
            }
            
            return true;
        }
        
        // 开始起名分析
        function startNaming() {
            console.log('开始起名分析...');
            try {
                showSection('loadingSection');
                
                const loadingTexts = [
                    '🔮 正在计算生辰八字...',
                    '🌟 分析五行缺失中...',
                    '💫 匹配最佳用字中...',
                    '🎊 生成专属好名中...'
                ];
                
                let index = 0;
                const interval = setInterval(() => {
                    try {
                        if (index < loadingTexts.length) {
                            const loadingTextElement = document.getElementById('loadingText');
                            if (loadingTextElement) {
                                loadingTextElement.textContent = loadingTexts[index];
                            }
                            index++;
                        } else {
                            clearInterval(interval);
                            setTimeout(() => {
                                generateResult();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Loading interval error:', error);
                        clearInterval(interval);
                    }
                }, 800);
            } catch (error) {
                console.error('startNaming error:', error);
                alert('起名过程中出现错误，请重试');
            }
        }
        
        // 生成起名结果
        function generateResult() {
            console.log('生成起名结果...');
            try {
                const surname = document.getElementById('surname').value.trim();
                const birthDate = document.getElementById('birthDate').value;
                const birthTime = document.getElementById('birthTime').value;
                const gender = selectedGender;
                
                console.log('表单数据:', { surname, birthDate, birthTime, gender });
                
                // 模拟计算八字
                const bazi = calculateBazi(birthDate, birthTime);
                
                // 模拟五行分析
                const wuxing = analyzeWuxing(bazi);
                
                // 模拟生成名字
                const names = generateNames(surname, gender, wuxing);
                
                currentResult = {
                    surname,
                    gender,
                    birthDate,
                    birthTime,
                    bazi,
                    wuxing,
                    names
                };
                
                console.log('生成的结果:', currentResult);
                displayResult();
            } catch (error) {
                console.error('generateResult error:', error);
                alert('生成结果时出现错误，请重试');
            }
        }
        
        // 计算八字（真实算法）
        function calculateBazi(date, time) {
            const heavenly = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const earthly = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            const birthDate = new Date(date + 'T' + time);
            const year = birthDate.getFullYear();
            const month = birthDate.getMonth() + 1;
            const day = birthDate.getDate();
            const hour = birthDate.getHours();
            
            // 年柱计算（以立春为界）
            let lunarYear = year;
            const springStart = getSpringDate(year);
            if (birthDate < springStart) {
                lunarYear = year - 1;
            }
            
            const yearSky = heavenly[(lunarYear - 4) % 10];
            const yearEarth = earthly[(lunarYear - 4) % 12];
            
            // 月柱计算（以节气为界）
            const monthIndex = getSolarMonth(birthDate);
            const monthSkyIndex = ((lunarYear - 4) % 10) * 2 + monthIndex;
            const monthSky = heavenly[monthSkyIndex % 10];
            const monthEarth = earthly[(monthIndex + 2) % 12];
            
            // 日柱计算（儒略日算法）
            const julianDay = getJulianDay(year, month, day);
            const daySkyIndex = (julianDay - 11) % 10;
            const dayEarthIndex = (julianDay - 11) % 12;
            const daySky = heavenly[daySkyIndex];
            const dayEarth = earthly[dayEarthIndex];
            
            // 时柱计算
            const hourIndex = Math.floor((hour + 1) / 2) % 12;
            const hourSkyIndex = (daySkyIndex * 2 + hourIndex) % 10;
            const hourSky = heavenly[hourSkyIndex];
            const hourEarth = earthly[hourIndex];
            
            return {
                year: yearSky + yearEarth,
                month: monthSky + monthEarth,
                day: daySky + dayEarth,
                hour: hourSky + hourEarth,
                elements: {
                    year: getElementFromStem(yearSky),
                    month: getElementFromStem(monthSky),
                    day: getElementFromStem(daySky),
                    hour: getElementFromStem(hourSky)
                }
            };
        }
        
        // 获取立春日期
        function getSpringDate(year) {
            // 简化计算，实际应用中需要更精确的节气计算
            return new Date(year, 1, 4); // 大约2月4日
        }
        
        // 获取节气月份
        function getSolarMonth(date) {
            const month = date.getMonth();
            const day = date.getDate();
            
            // 简化的节气计算
            const solarMonths = [11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            let solarMonth = solarMonths[month];
            
            // 根据具体日期调整（简化版本）
            if ((month === 0 && day < 6) || (month === 11 && day >= 6)) {
                solarMonth = month === 0 ? 11 : 0;
            }
            
            return solarMonth;
        }
        
        // 儒略日计算
        function getJulianDay(year, month, day) {
            if (month <= 2) {
                year -= 1;
                month += 12;
            }
            const a = Math.floor(year / 100);
            const b = 2 - a + Math.floor(a / 4);
            return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + b - 1524;
        }
        
        // 从天干获取五行
        function getElementFromStem(stem) {
            const stemElements = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return stemElements[stem] || '木';
        }
        
        // 五行分析（真实算法）
        function analyzeWuxing(bazi) {
            // 统计八字中的五行
            const elements = { '金': 0, '木': 0, '水': 0, '火': 0, '土': 0 };
            
            // 从天干分析
            Object.values(bazi.elements).forEach(element => {
                elements[element]++;
            });
            
            // 从地支分析（简化版本）
            const branchElements = {
                '子': '水', '亥': '水',
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '申': '金', '酉': '金',
                '辰': '土', '戌': '土', '丑': '土', '未': '土'
            };
            
            [bazi.year, bazi.month, bazi.day, bazi.hour].forEach(pillar => {
                const branch = pillar[1];
                const element = branchElements[branch];
                if (element) {
                    elements[element]++;
                }
            });
            
            // 分析五行强弱
            const total = Object.values(elements).reduce((sum, count) => sum + count, 0);
            const lacking = [];
            const weak = [];
            const strong = [];
            
            Object.entries(elements).forEach(([element, count]) => {
                const percentage = count / total;
                if (count === 0) {
                    lacking.push(element);
                } else if (percentage < 0.15) {
                    weak.push(element);
                } else if (percentage > 0.3) {
                    strong.push(element);
                }
            });
            
            // 生成建议
            let suggestion = '';
            if (lacking.length > 0) {
                const needElement = lacking[0];
                suggestion = `五行缺${lacking.join('、')}，建议选用${needElement}字旁的字，如：${getElementSamples(needElement)}`;
            } else if (weak.length > 0) {
                const needElement = weak[0];
                suggestion = `五行${weak.join('、')}偏弱，建议加强${needElement}字旁的字，如：${getElementSamples(needElement)}`;
            } else {
                suggestion = '五行相对平衡，可根据音韵美感选择用字';
            }
            
            return { 
                elements, 
                lacking, 
                weak,
                strong,
                suggestion,
                needElement: lacking.length > 0 ? lacking[0] : (weak.length > 0 ? weak[0] : null)
            };
        }
        
        // 获取五行用字示例
        function getElementSamples(element) {
            const samples = {
                '金': '鑫、钰、铭、锐、钢',
                '木': '林、森、楠、柏、桂', 
                '水': '海、江、涛、润、泽',
                '火': '炎、煜、烨、灿、晖',
                '土': '坤、圳、城、培、堃'
            };
            return samples[element] || '';
        }
        
        // 生成名字（现代化增强算法）
        function generateNames(surname, gender, wuxing) {
            try {
                // 获取完整的字库
                const nameDatabase = getNameDatabase();
                const modernCombos = getModernCombinations();
                const targetElement = wuxing.needElement;
                
                console.log('现代字库大小:', nameDatabase.length);
                console.log('目标性别:', gender);
                console.log('目标五行:', targetElement);
                console.log('现代组合数据:', modernCombos);
                
                if (!nameDatabase || nameDatabase.length === 0) {
                    console.error('字库数据为空，使用备用算法');
                    return generateBackupNames(surname, gender, wuxing);
                }
                
                const nameList = [];
            
            // 第一优先级：使用现代流行组合
            if (modernCombos[gender]) {
                console.log('尝试现代流行组合...');
                for (const combo of modernCombos[gender]) {
                    const char1Data = nameDatabase.find(c => c.char === combo[0]);
                    const char2Data = nameDatabase.find(c => c.char === combo[1]);
                    
                    if (char1Data && char2Data) {
                        const name = char1Data.char + char2Data.char;
                        const fullName = surname + name;
                        
                        // 计算评分（现代组合自动加分）
                        const score = calculateModernNameScore(surname, name, wuxing, char1Data, char2Data, true);
                        
                        nameList.push({
                            name,
                            fullName,
                            meaning: generateModernMeaning(char1Data, char2Data),
                            score,
                            wuxing: char1Data.element + char2Data.element,
                            isTop: false,
                            strokes: char1Data.strokes + char2Data.strokes,
                            style: combineStyles(char1Data.style, char2Data.style),
                            pinyin: generatePinyin(surname, char1Data, char2Data),
                            isModern: true
                        });
                    }
                }
            }
            
            // 第二优先级：智能生成现代风格组合
            console.log('智能生成现代组合...');
            const modernChars = nameDatabase.filter(char => {
                // 优先选择现代风格的字
                const modernStyles = ['modern', 'elegant', 'fresh', 'gentle', 'joyful', 'dreamy'];
                return (char.gender.includes(gender) || char.gender.includes('both')) &&
                       (char.style && modernStyles.includes(char.style));
            });
            
            // 如果现代风格字符不够，添加所有性别适合的字符
            if (modernChars.length < 20) {
                const allGenderChars = nameDatabase.filter(char => 
                    char.gender.includes(gender) || char.gender.includes('both')
                );
                modernChars.push(...allGenderChars.filter(char => !modernChars.includes(char)));
            }
            
            // 五行补强字符
            const elementChars = targetElement ? 
                nameDatabase.filter(char => 
                    char.element === targetElement && 
                    (char.gender.includes(gender) || char.gender.includes('both'))
                ) : [];
            
            // 合并字符池
            let allCandidates = [...modernChars];
            if (elementChars.length > 0) {
                // 五行匹配的字增加权重
                allCandidates = allCandidates.concat(elementChars).concat(elementChars);
            }
            
            // 生成智能组合
            const maxAttempts = Math.min(allCandidates.length * 20, 300);
            for (let attempt = 0; attempt < maxAttempts && nameList.length < 30; attempt++) {
                const char1 = allCandidates[Math.floor(Math.random() * allCandidates.length)];
                const char2 = allCandidates[Math.floor(Math.random() * allCandidates.length)];
                
                if (char1.char === char2.char) continue;
                
                const name = char1.char + char2.char;
                
                // 检查重复
                if (nameList.some(existing => existing.name === name)) continue;
                
                // 现代化和谐度检查
                if (!isModernHarmoniousName(char1, char2, gender)) continue;
                
                const fullName = surname + name;
                const score = calculateModernNameScore(surname, name, wuxing, char1, char2, false);
                
                nameList.push({
                    name,
                    fullName,
                    meaning: generateModernMeaning(char1, char2),
                    score,
                    wuxing: char1.element + char2.element,
                    isTop: false,
                    strokes: char1.strokes + char2.strokes,
                    style: combineStyles(char1.style, char2.style),
                    pinyin: generatePinyin(surname, char1, char2),
                    isModern: false
                });
            }
            
            // 按评分排序，现代组合优先
            nameList.sort((a, b) => {
                if (a.isModern && !b.isModern) return -1;
                if (!a.isModern && b.isModern) return 1;
                return b.score - a.score;
            });
            
            // 标记最佳名字
            nameList.forEach((name, index) => {
                name.isTop = index === 0;
            });
            
            console.log('生成的名字数量:', nameList.length);
            return nameList.slice(0, 5);
            } catch (error) {
                console.error('生成名字时出错:', error);
                return generateBackupNames(surname, gender, wuxing);
            }
        }
        
        // 现代化名字评分系统
        function calculateModernNameScore(surname, name, wuxing, char1, char2, isPresetCombo) {
            let score = 70; // 基础分
            
            // 现代预设组合加分
            if (isPresetCombo) score += 15;
            
            // 风格加分
            const modernStyles = ['modern', 'elegant', 'fresh', 'gentle', 'joyful', 'dreamy'];
            if (char1.style && modernStyles.includes(char1.style)) score += 5;
            if (char2.style && modernStyles.includes(char2.style)) score += 5;
            
            // 五行匹配加分
            if (wuxing.needElement) {
                if (char1.element === wuxing.needElement) score += 8;
                if (char2.element === wuxing.needElement) score += 8;
            }
            
            // 字音韵律加分
            const phonetics = analyzePhonetics(surname + name);
            if (phonetics.includes('顺口')) score += 5;
            if (phonetics.includes('响亮')) score += 3;
            
            // 笔画数适中加分
            const totalStrokes = char1.strokes + char2.strokes;
            if (totalStrokes >= 12 && totalStrokes <= 25) score += 5;
            
            // 避免老气字符扣分
            const oldStyleChars = ['福', '贵', '财', '富', '康', '寿', '德', '仁', '义', '礼'];
            if (oldStyleChars.includes(char1.char)) score -= 10;
            if (oldStyleChars.includes(char2.char)) score -= 10;
            
            // 现代流行字符加分
            const trendyChars = ['梓', '涵', '萱', '汐', '晨', '煜', '睿', '琳', '诗', '语'];
            if (trendyChars.includes(char1.char)) score += 6;
            if (trendyChars.includes(char2.char)) score += 6;
            
            return Math.min(score, 100);
        }
        
        // 现代化和谐度检查
        function isModernHarmoniousName(char1, char2, gender) {
            // 避免老气组合
            const oldCombos = [
                ['福', '贵'], ['富', '贵'], ['康', '宁'], ['德', '义'], ['仁', '德'],
                ['志', '强'], ['建', '国'], ['爱', '国'], ['国', '强'], ['建', '军']
            ];
            
            for (const combo of oldCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return false;
                }
            }
            
            // 现代推荐组合
            const modernCombos = {
                'male': [
                    ['宇', '轩'], ['浩', '然'], ['梓', '轩'], ['子', '涵'], ['俊', '熙'],
                    ['煜', '祺'], ['睿', '泽'], ['明', '轩'], ['博', '文'], ['凯', '然']
                ],
                'female': [
                    ['雨', '桐'], ['诗', '涵'], ['语', '汐'], ['沐', '晴'], ['思', '雅'],
                    ['梓', '萱'], ['若', '汐'], ['美', '琳'], ['静', '雅'], ['艾', '琳']
                ]
            };
            
            const genderCombos = modernCombos[gender] || [];
            for (const combo of genderCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return true;
                }
            }
            
            // 检查风格匹配
            const compatibleStyles = {
                'modern': ['elegant', 'fresh', 'bright'],
                'elegant': ['gentle', 'peaceful', 'noble'],
                'fresh': ['joyful', 'natural', 'pure'],
                'gentle': ['peaceful', 'tender', 'dreamy']
            };
            
            const style1Compat = compatibleStyles[char1.style || 'classic'] || [];
            if (style1Compat.includes(char2.style) || char1.style === char2.style) {
                return true;
            }
            
            return Math.random() > 0.7; // 30%的机会接受其他组合
        }
        
        // 生成现代化寓意
        function generateModernMeaning(char1, char2) {
            const style1 = char1.style || 'classic';
            const style2 = char2.style || 'classic';
            
            const styleDescriptions = {
                'modern': '时尚现代，与时俱进',
                'elegant': '优雅高贵，气质出众', 
                'fresh': '清新自然，朝气蓬勃',
                'gentle': '温柔如水，柔情似水',
                'joyful': '欢乐喜悦，开朗活泼',
                'dreamy': '梦幻浪漫，充满想象'
            };
            
            const desc1 = styleDescriptions[style1] || '品德高尚';
            const desc2 = styleDescriptions[style2] || '才华出众';
            
            return `${char1.char}寓意${char1.meaning.split('，')[0]}，${char2.char}寓意${char2.meaning.split('，')[0]}。整体${desc1}，${desc2}，是现代父母的理想选择。`;
        }
        
        // 组合风格
        function combineStyles(style1, style2) {
            if (style1 === style2) return style1;
            
            const combinations = {
                'modern_elegant': '现代优雅',
                'elegant_gentle': '优雅温柔', 
                'fresh_joyful': '清新欢快',
                'gentle_dreamy': '温柔梦幻',
                'modern_fresh': '现代清新',
                'elegant_dreamy': '优雅梦幻'
            };
            
            const key = [style1, style2].sort().join('_');
            return combinations[key] || '和谐搭配';
        }
        
        // 备用起名算法（简化版本）
        function generateBackupNames(surname, gender, wuxing) {
            console.log('使用备用起名算法');
            const backupNames = {
                male: [
                    { name: '宇轩', score: 95, meaning: '宇宙广阔，气宇轩昂，寓意胸襟开阔，风度翩翩' },
                    { name: '浩然', score: 92, meaning: '浩然正气，刚正不阿，寓意品格高尚，正直善良' },
                    { name: '子涵', score: 90, meaning: '才子佳人，涵养深厚，寓意才华横溢，修养极佳' },
                    { name: '俊熙', score: 88, meaning: '俊朗英俊，熙熙融融，寓意英俊潇洒，前程光明' },
                    { name: '梓轩', score: 86, meaning: '梓材良木，轩昂气宇，寓意成才有望，气度不凡' }
                ],
                female: [
                    { name: '雨桐', score: 95, meaning: '细雨梧桐，清新雅致，寓意温柔如水，高雅脱俗' },
                    { name: '诗涵', score: 92, meaning: '诗情画意，涵养深厚，寓意才华横溢，书香门第' },
                    { name: '语汐', score: 90, meaning: '语言优美，汐水轻柔，寓意才思敏捷，温柔可人' },
                    { name: '沐晴', score: 88, meaning: '沐浴阳光，晴空万里，寓意阳光开朗，心情愉悦' },
                    { name: '思雅', score: 86, meaning: '思维敏捷，高雅脱俗，寓意聪慧过人，品味不凡' }
                ]
            };
            
            const genderNames = backupNames[gender] || backupNames.male;
            return genderNames.map((nameData, index) => ({
                name: nameData.name,
                fullName: surname + nameData.name,
                meaning: nameData.meaning,
                score: nameData.score,
                wuxing: '木火',
                isTop: index === 0,
                strokes: 20,
                style: '现代优雅',
                pinyin: `${surname} ${nameData.name.charAt(0)} ${nameData.name.charAt(1)}`,
                isModern: true
            }));
        }
        
        // 获取现代组合
        function getModernCombinations() {
            if (typeof MODERN_COMBINATIONS !== 'undefined') {
                return MODERN_COMBINATIONS;
            } else {
                // 备用现代组合
                return {
                    male: [
                        ['宇', '轩'], ['浩', '然'], ['子', '轩'], ['梓', '轩'], 
                        ['俊', '熙'], ['煜', '祺'], ['睿', '泽'], ['明', '轩']
                    ],
                    female: [
                        ['雨', '桐'], ['诗', '涵'], ['语', '汐'], ['沐', '晴'],
                        ['思', '雅'], ['梓', '萱'], ['若', '汐'], ['美', '琳']
                    ]
                };
            }
        }
        
        // 数组随机打乱函数
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // 生成拼音函数
        function generatePinyin(surname, char1, char2) {
            // 常见姓氏拼音映射
            const surnameMap = {
                '张': 'zhāng', '王': 'wáng', '李': 'lǐ', '刘': 'liú', '陈': 'chén', 
                '杨': 'yáng', '赵': 'zhào', '黄': 'huáng', '周': 'zhōu', '吴': 'wú',
                '徐': 'xú', '孙': 'sūn', '胡': 'hú', '朱': 'zhū', '高': 'gāo',
                '林': 'lín', '何': 'hé', '郭': 'guō', '马': 'mǎ', '罗': 'luó',
                '梁': 'liáng', '宋': 'sòng', '郑': 'zhèng', '谢': 'xiè', '韩': 'hán',
                '唐': 'táng', '冯': 'féng', '于': 'yú', '董': 'dǒng', '萧': 'xiāo'
            };
            
            const surnamePin = surnameMap[surname] || surname;
            const char1Pin = char1.pinyin || char1.char;
            const char2Pin = char2.pinyin || char2.char;
            
            return `${surnamePin} ${char1Pin} ${char2Pin}`;
        }
        
        // 检查名字组合和谐度
        function isHarmoniousNameCombination(char1, char2, gender) {
            // 避免五行相克的组合
            const conflictElements = {
                '金': ['木'],
                '木': ['土'],
                '土': ['水'],
                '水': ['火'],
                '火': ['金']
            };
            
            if (conflictElements[char1.element] && conflictElements[char1.element].includes(char2.element)) {
                return false;
            }
            
            // 推荐的美好组合（按性别优化）
            const harmoniousCombos = {
                'male': [
                    // 男生推荐组合：力量、智慧、成功类
                    ['宇', '轩'], ['浩', '然'], ['俊', '杰'], ['博', '文'], ['志', '强'],
                    ['铭', '轩'], ['睿', '宇'], ['煜', '辰'], ['峰', '涛'], ['承', '德'],
                    ['思', '远'], ['明', '轩'], ['锐', '峰'], ['宸', '昊'], ['智', '勇']
                ],
                'female': [
                    // 女生推荐组合：美丽、优雅、智慧类
                    ['雅', '琳'], ['诗', '涵'], ['婷', '雯'], ['慧', '琪'], ['美', '琳'],
                    ['思', '雅'], ['梦', '瑶'], ['诗', '婷'], ['雨', '萱'], ['晴', '雪'],
                    ['颖', '慧'], ['静', '雅'], ['美', '娜'], ['琳', '娜'], ['雅', '欣']
                ]
            };
            
            const genderCombos = harmoniousCombos[gender] || [];
            for (const combo of genderCombos) {
                if ((combo[0] === char1.char && combo[1] === char2.char) ||
                    (combo[1] === char1.char && combo[0] === char2.char)) {
                    return true;
                }
            }
            
            // 检查字符含义搭配是否和谐
            const negativeKeywords = ['病', '死', '凶', '恶', '衰', '败', '穷', '苦'];
            for (const keyword of negativeKeywords) {
                if (char1.meaning.includes(keyword) || char2.meaning.includes(keyword)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 获取字库数据
        function getNameDatabase() {
            // 使用外部字库文件中的数据
            return typeof NAME_DATABASE !== 'undefined' ? NAME_DATABASE : [];
        }
        
        // 显示结果
        function displayResult() {
            console.log('开始显示结果...');
            try {
                // 显示八字信息
                const baziInfo = document.getElementById('baziInfo');
            baziInfo.innerHTML = `
                <div>出生日期：${currentResult.birthDate}</div>
                <div>出生时间：${currentResult.birthTime}</div>
                <div>年柱：${currentResult.bazi.year}</div>
                <div>月柱：${currentResult.bazi.month}</div>
                <div>日柱：${currentResult.bazi.day}</div>
                <div>时柱：${currentResult.bazi.hour}</div>
            `;
            
            // 显示五行分析
            const wuxingAnalysis = document.getElementById('wuxingAnalysis');
            let wuxingHtml = '';
            Object.entries(currentResult.wuxing.elements).forEach(([element, count]) => {
                const stars = '★'.repeat(count) + '☆'.repeat(4 - count);
                wuxingHtml += `
                    <div class="wuxing-item">
                        <span class="wuxing-name">${element}：</span>
                        <span class="wuxing-stars">${stars}</span>
                    </div>
                `;
            });
            wuxingHtml += `<p style="margin-top: 15px; color: #666; font-size: 14px;">${currentResult.wuxing.suggestion}</p>`;
            wuxingAnalysis.innerHTML = wuxingHtml;
            
            // 显示推荐名字
            const nameResults = document.getElementById('nameResults');
            let namesHtml = '';
            currentResult.names.forEach((name, index) => {
                const stars = '⭐'.repeat(Math.floor(name.score / 20));
                const complementInfo = currentResult.wuxing.needElement ? `，补${currentResult.wuxing.needElement}强运` : '';
                
                // 现代化标识
                const modernBadge = name.isModern ? '<span class="modern-badge">🎯 流行推荐</span>' : '';
                const styleBadge = name.style ? `<span class="style-badge">💫 ${name.style}</span>` : '';
                
                namesHtml += `
                    <div class="name-card ${name.isTop ? 'best' : ''} ${name.isModern ? 'modern-combo' : ''}">
                        <div class="name-header">
                            <div class="name-text">【${name.fullName}】</div>
                            <div class="name-score">${name.score}分</div>
                        </div>
                        <div class="name-badges">
                            ${modernBadge}
                            ${styleBadge}
                        </div>
                        <div class="name-pinyin">📝 拼音：${name.pinyin}</div>
                        <div class="name-stars">${stars}</div>
                        <div class="name-meaning">📖 ${name.meaning}</div>
                        <div class="name-wuxing">🔥 五行：${name.wuxing}${complementInfo}</div>
                        <div class="name-wuxing">✍️ 笔画：${name.strokes}画</div>
                        <div class="name-wuxing">🎵 音韵：${analyzePhonetics(name.fullName)}</div>
                    </div>
                `;
            });
            nameResults.innerHTML = namesHtml;
            
            showSection('resultSection');
            console.log('结果显示完成');
            } catch (error) {
                console.error('displayResult error:', error);
                alert('显示结果时出现错误，请重试');
            }
        }
        
        // 切换显示的页面
        function showSection(sectionId) {
            console.log('切换到页面:', sectionId);
            try {
                const sections = ['formSection', 'loadingSection', 'resultSection'];
                
                // 隐藏所有页面
                sections.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        element.style.opacity = '0';
                    }
                });
                
                // 显示目标页面
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.style.display = 'block';
                    targetSection.style.visibility = 'visible';
                    targetSection.style.opacity = '1';
                    targetSection.style.position = 'relative';
                    targetSection.style.left = 'auto';
                    console.log('成功显示页面:', sectionId);
                } else {
                    console.error('找不到目标页面:', sectionId);
                }
            } catch (error) {
                console.error('showSection error:', error);
            }
        }
        
        // 分享结果
        function shareResult() {
            if (!currentResult) return;
            
            const shareText = `我给宝宝用AI起了个好名字：${currentResult.names[0].fullName}，综合评分${currentResult.names[0].score}分！\n\n传承千年命理智慧，AI科学起好名\n👶 你也想给宝宝起个好名字吗？`;
            
            if (navigator.share) {
                navigator.share({
                    title: '宝宝智能起名神器',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // 复制到剪贴板
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    alert('分享内容已复制到剪贴板，快去朋友圈分享吧！');
                });
            }
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('namingForm').reset();
            document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('active'));
            selectedGender = '';
            currentResult = null;
            
            // 重新设置默认日期
            const today = new Date();
            document.getElementById('birthDate').value = today.toISOString().split('T')[0];
            document.getElementById('birthTime').value = '12:00';
            
            showSection('formSection');
        }
        
        // 计算名字评分
        function calculateNameScore(surname, name, wuxing) {
            let score = 0;
            
            // 1. 五行匹配度 (40分)
            if (wuxing.needElement) {
                const nameDatabase = getNameDatabase();
                const nameChars = name.split('');
                let matchCount = 0;
                
                nameChars.forEach(char => {
                    const charData = nameDatabase.find(c => c.char === char);
                    if (charData && charData.element === wuxing.needElement) {
                        matchCount++;
                    }
                });
                
                score += (matchCount / nameChars.length) * 40;
            } else {
                score += 35; // 五行平衡时给基础分
            }
            
            // 2. 笔画数理 (25分)
            const strokeScore = calculateStrokeScore(surname, name);
            score += strokeScore;
            
            // 3. 音韵美感 (20分)
            const phoneticScore = calculatePhoneticScore(surname + name);
            score += phoneticScore;
            
            // 4. 寓意吉祥 (15分)
            const meaningScore = calculateMeaningScore(name);
            score += meaningScore;
            
            return Math.round(score);
        }
        
        // 计算笔画数理评分
        function calculateStrokeScore(surname, name) {
            const nameDatabase = getNameDatabase();
            const surnameStrokes = getCharStrokes(surname);
            
            let totalStrokes = surnameStrokes;
            name.split('').forEach(char => {
                const charData = nameDatabase.find(c => c.char === char);
                totalStrokes += charData ? charData.strokes : 10;
            });
            
            // 根据总笔画数判断吉凶（简化版本）
            const luckyNumbers = [1, 3, 5, 6, 7, 8, 11, 13, 15, 16, 17, 18, 21, 23, 24, 25, 29, 31, 32, 33, 35, 37, 39, 41, 45, 47, 48, 52, 57, 61, 63, 65, 67, 68, 81];
            
            if (luckyNumbers.includes(totalStrokes % 81)) {
                return 25;
            } else if (totalStrokes % 81 < 40) {
                return 15;
            } else {
                return 10;
            }
        }
        
        // 获取单字笔画数
        function getCharStrokes(char) {
            const commonStrokes = {
                '王': 4, '李': 7, '张': 11, '刘': 15, '陈': 16, '杨': 13, '赵': 14, '黄': 12, '周': 8, '吴': 7,
                '徐': 10, '孙': 6, '胡': 9, '朱': 6, '高': 10, '林': 8, '何': 7, '郭': 15, '马': 10, '罗': 19,
                '梁': 11, '宋': 7, '郑': 19, '谢': 17, '韩': 17, '唐': 10, '冯': 12, '于': 3, '董': 15, '萧': 18
            };
            return commonStrokes[char] || 8; // 默认8画
        }
        
        // 计算音韵评分
        function calculatePhoneticScore(fullName) {
            const tones = getTonesPattern(fullName);
            
            // 检查声调搭配是否和谐
            if (tones.length >= 3) {
                // 避免三个字都是同一声调
                if (tones[0] === tones[1] && tones[1] === tones[2]) {
                    return 10;
                }
                // 平仄相间比较好听
                if ((tones[0] !== tones[1]) && (tones[1] !== tones[2])) {
                    return 20;
                }
                return 15;
            }
            return 12;
        }
        
        // 获取字的声调（简化版本）
        function getTonesPattern(name) {
            const toneMap = {
                // 一声（阴平）
                '张': 1, '王': 2, '李': 3, '刘': 2, '陈': 2, '杨': 2, '周': 1, '吴': 2,
                '鑫': 1, '钰': 4, '林': 2, '海': 3, '炎': 2, '坤': 1,
                '轩': 1, '睿': 4, '涵': 2, '诗': 1, '雨': 3, '悦': 4
            };
            
            return name.split('').map(char => toneMap[char] || 2);
        }
        
        // 计算寓意评分
        function calculateMeaningScore(name) {
            const positiveChars = ['鑫', '钰', '林', '海', '炎', '坤', '轩', '睿', '涵', '诗', '雨', '悦', '雅', '琪', '瑶', '慧', '宇', '辰', '晨'];
            let score = 0;
            
            name.split('').forEach(char => {
                if (positiveChars.includes(char)) {
                    score += 7.5;
                } else {
                    score += 5;
                }
            });
            
            return Math.min(score, 15);
        }
        
        // 音韵分析
        function analyzePhonetics(fullName) {
            const tones = getTonesPattern(fullName);
            const toneNames = ['', '平声', '上声', '去声', '入声'];
            
            let pattern = tones.map(tone => toneNames[tone] || '平声').join('-');
            
            // 判断音韵特点
            let analysis = '';
            if (tones.every(tone => tone === tones[0])) {
                analysis = '声调统一，音韵平稳';
            } else if (tones[0] !== tones[1] && tones[1] !== tones[2]) {
                analysis = '平仄相间，朗朗上口';
            } else {
                analysis = '音调和谐，悦耳动听';
            }
            
            return { pattern, analysis };
        }
    </script>
</body>
</html> 